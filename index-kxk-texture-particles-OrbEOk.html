<html lang="pt-BR"><head>
  <meta charset="utf-8">
  <title>dual.Infodose — Fusion Unificado (Chat Cinematográfico + Fusion HUD)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#05070a">
<link rel="apple-touch-icon" href="./icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600;700;900&amp;family=JetBrains+Mono:wght@400;700&amp;display=swap" rel="stylesheet">

  <!-- External Libraries (CDN) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<!-- Markdown renderer + sanitizer + syntax highlight -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<!-- opcional: prism extras se quiser linguagens extras -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <style>
    /* ====== Combined variables & base ====== */
    :root{
      /* Chat app vars */
      --bg-dark: linear-gradient(to bottom,#000,#1a1a1a);
      --text-dark:#fff; --primary:#111; --secondary:#5e5c5e;
      --accent:#0ff; --fast:0.4s; --med:0.8s; --slow:1.8s;
      /* Fusion vars */
      --bg-deep:#030406; --glass-surface:rgba(18,18,22,0.65); --glass-border:rgba(255,255,255,0.06);
      --neon-cyan:#00f2ff; --neon-purple:#bd00ff; --neon-gold:#ffd700; --neon-danger:#ff2a6d; --neon-success:#00ff9d;
      --font-ui:'Montserrat',sans-serif; --font-code:'JetBrains Mono',monospace;
      --ease-overshoot: cubic-bezier(0.34, 1.3, 0.64, 1);
      --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
    }

    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;outline:none;user-select:none}
    html,body{height:100%;min-height:100vh}
    
    body{
      font-family:var(--font-ui); color:var(--text-dark);
      /* CORREÇÃO DO FUNDO BRANCO: Definindo cor base preta e empilhando os backgrounds corretamente */
     background-color: #000;
background-image:
  radial-gradient(circle at 20% 30%, rgba(255,255,255,0.04), transparent 40%),
  radial-gradient(circle at 80% 70%, rgba(255,255,255,0.03), transparent 45%),
  var(--bg-dark);
background-size: 100% 100%;
background-attachment: fixed;
      padding:20px; overflow:hidden; display:flex; flex-direction:column; align-items:center;
    }

/* Markdown body styles */
.markdown-body{font-family:var(--font-ui);color:var(--text-dark);line-height:1.55}
.markdown-body h1, .markdown-body h2, .markdown-body h3 { color: var(--accent); margin:0.4rem 0; }
.markdown-body p { margin:0.55rem 0; color:rgba(255,255,255,0.92); }
.markdown-body ul, .markdown-body ol { margin:0.4rem 0 0.8rem 1.1rem; color:rgba(255,255,255,0.9); }
.markdown-body strong { color:#fff; font-weight:700 }
.markdown-body em { font-style:italic; color:rgba(255,255,255,0.85) }
.markdown-body blockquote { border-left:3px solid rgba(255,255,255,0.06); padding:8px 12px; background:rgba(255,255,255,0.02); color:rgba(255,255,255,0.85); margin:0.6rem 0; border-radius:6px }
.markdown-body pre { background: rgba(0,0,0,0.6); padding:12px; border-radius:8px; overflow:auto; font-family:var(--font-code); font-size:0.85rem; margin:0.6rem 0; }
.markdown-body code { background: rgba(255,255,255,0.03); padding:2px 6px; border-radius:6px; font-family:var(--font-code); color:#fff }
.response-block .meta { z-index:6 } /* mantém botão cristal por cima */
.response-block .block-actions { position:absolute; left:12px; bottom:12px; display:flex; gap:8px; }
.copy-block-btn{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:6px 8px; border-radius:8px; color:var(--accent); cursor:pointer }

    /* ====== Particles / Ambient ====== */
    #particles-js{position:absolute;inset:0;z-index:13;pointer-events:none}
    .ambient-light{position:fixed;inset:0;z-index:0;pointer-events:none}
    .blob{position:absolute;border-radius:50%;filter:blur(100px);opacity:0.14;animation:float 25s infinite alternate ease-in-out}
    .blob-1{width:60vw;height:60vw;background:var(--neon-cyan);top:-20%;left:-20%}
    .blob-2{width:50vw;height:50vw;background:var(--neon-purple);bottom:-20%;right:-20%;animation-delay:-5s}
    @keyframes float{0%{transform:translate(0,0)}100%{transform:translate(40px,60px)}}

    /* ====== Chat Cinematográfico styles ====== */
    .svg-container{
        position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);
        width:160px;height:160px;z-index:1;
        display: flex; justify-content: center; align-items: center;
        opacity: 0.8;
    }
    .svg-container object{width:100%;height:100%}
    
    .top-info {
      position: fixed; top: 18px; left: 20px; z-index: 5;
      background: rgba(0,0,0,0.35); padding: 8px 12px; border-radius: 12px; font-size: 0.9em;
      backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.05);
    }
    .response-container{
      position:fixed; left:20px; right:20px; bottom:160px;
      padding:12px;background:rgba(0,0,0,0.4);backdrop-filter:blur(10px);
      border-radius:20px; max-height:calc(100vh - 220px); overflow-y:auto; -webkit-overflow-scrolling:touch; z-index:4;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .page{display:none; opacity:0; transition:opacity var(--med) ease-in-out}
    .page.active{display:block; opacity:1}
    .page.initial{text-align:center;font-size:1.1em; color: rgba(255,255,255,0.8);}
    
    .response-controls{display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2)}
    .control-buttons{display:flex;gap:10px;align-items:center}
    .control-btn{background:rgba(255,255,255,0.05);padding:6px;border-radius:6px;cursor:pointer;transition:background var(--fast);display:flex;gap:6px;border:none;outline:none; color: #fff;}
    .control-btn:hover{background:rgba(255,255,255,0.12)}
    .control-btn svg { stroke: currentColor; fill: none; }
    .toggle-button.active{color:#0f0}
    
    .pagination{display:flex;align-items:center;gap:10px}
    .pagination button{background:none;border:none;font-size:1.2em;color:#6fe4fb;cursor:pointer;transition:transform var(--fast)}
    .pagination button:hover{transform:scale(1.2)}
    
    .response-block{
      margin:1rem 0;padding:1.2rem;border-radius:12px;
      animation:fadeIn var(--slow) ease forwards; transition:box-shadow var(--fast),transform var(--fast);
      line-height:1.5;position:relative;cursor:pointer;overflow:hidden;animation:pulse 6s infinite ease-in-out;
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));
      border: 1px solid rgba(255,255,255,0.03);
    }
    .response-block h3{margin-bottom:12px; color: var(--accent);}
    .response-block:hover{box-shadow:0 0 15px rgba(0,255,255,0.12)}
    .response-block .meta { position:absolute; top:8px; right:8px; display:flex; gap:6px; }
    .crystal-btn { background: rgba(0,0,0,0.25); border-radius:6px; padding:6px; cursor:pointer; border:none; color:var(--accent); }
    .response-block.clicked{animation:clickPulse var(--med) ease-out}
    .response-block.expanded{transform:scale(1.03); background:rgba(0,0,0,0.6); z-index:6}
    .intro{background:linear-gradient(135deg,rgba(0,255,255,0.08),rgba(0,100,100,0.04));border-left:4px solid #0ff}
    .middle{background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(50,50,50,0.06));border-left:4px solid rgba(255,255,255,0.2)}
    .ending{background:linear-gradient(135deg,rgba(255,0,255,0.06),rgba(100,0,100,0.04));border-left:4px solid #f0f}
    .footer-text{margin-top:12px;font-size:0.8em;text-align:center;font-style:italic; opacity: 0.7;}
    
    .input-container{position:fixed;left:20px;right:20px;bottom:90px;display:flex;gap:10px;z-index:5;max-width:calc(100% - 40px)}
    .input-container input{flex:1;padding:15px;border:none;border-radius:20px;background:rgba(255,255,255,0.1);color:inherit;outline:none;font-size:16px;transition:background var(--fast); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);}
    .input-container input:focus{background:rgba(255,255,255,0.2)}
    .input-container button{width:54px;height:54px;border:none;border-radius:50%;background:linear-gradient(45deg,var(--primary),var(--secondary));color:#fff;font-size:1.5em;cursor:pointer;display:flex;justify-content:center;align-items:center;animation:pulse 2s infinite ease-in-out;transition:transform var(--fast); border: 1px solid rgba(255,255,255,0.2);}
    .input-container button:hover{transform:scale(1.1)}
    
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes clickPulse{0%,100%{opacity:1}50%{opacity:0.8}}

    /* Settings + Toggle Panel + Crystal Modal */
    .modal, .panel { position: fixed; inset: 0; display: none; z-index: 9998; justify-content:center; align-items:center; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
    .modal.active, .panel.active { display:flex }
    .box {
      background:#1a1a1a;padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);
      width:90%;max-width:520px;box-shadow:0 8px 40px rgba(0,0,0,0.6); color:#fff;
    }
    .box h3{color:var(--accent);margin-bottom:8px}
    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .input-group label{font-size:0.85em;color:#aaa;margin-left:4px}
    .input-group input[type="text"], .input-group input[type="password"], .input-group input[type="file"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.5);color:#fff;outline:none;
    }
    .settings-actions{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-prim{background:var(--accent);color:#000}
    .btn-sec{background:rgba(255,255,255,0.08);color:#fff}
    .small {font-size:0.85em;color:#bbb}
    .crystal-list { max-height:300px; overflow:auto; display:flex; flex-direction:column; gap:8px }
    .crystal-item { background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; display:flex; justify-content:space-between; gap:8px; align-items:flex-start }
    .crystal-item .actions { display:flex; gap:6px }

    /* Mantra footer */
    #mantra-toggle {
      position: fixed;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      background: rgba(15, 15, 15, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 10px 24px;
      border-radius: 100px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      min-width: 280px;
    }
    #mantra-toggle.collapsed { background: transparent; border-color: rgba(255, 215, 0, 0.3); padding: 10px 40px; }
    #mantra-text { font-style: italic; color: #777; font-size: 0.85rem; white-space: nowrap; transition: all 0.4s ease; }
    .fade-out { opacity: 0; transform: translateY(-5px); }
    .fade-in { opacity: 0; transform: translateY(5px); }

    /* Hide UI on zen mode */
    body.zen-mode .response-container,
    body.zen-mode .input-container,
    body.zen-mode .top-info,
    body.zen-mode .svg-container {
      opacity: 0; pointer-events: none; filter: blur(12px); transition: all 0.6s ease;
    }

    /* ====== Fusion HUD / Card styles ====== */
    .container{
      position: absolute; inset:0; pointer-events:none;
      display:flex; align-items:center; justify-content:center; perspective:1200px; z-index:10;
    }
    .fusion-card{
      pointer-events:auto;
      width:100%; max-width:440px;
      background:var(--glass-surface); backdrop-filter:blur(30px); -webkit-backdrop-filter:blur(30px);
      border:1px solid var(--glass-border); border-radius:36px; padding:30px 25px;
      box-shadow:0 40px 100px rgba(0,0,0,0.8);
      position:relative; opacity:0; transform:translateY(50px) scale(0.96);
      display:flex; flex-direction:column; gap:8px;
      transition: width 0.5s var(--ease-smooth), height 0.5s var(--ease-smooth), border-radius 0.5s var(--ease-smooth), transform 0.4s var(--ease-smooth), opacity 0.4s;
      will-change: transform, width, height, border-radius, left, top;
      touch-action: none;
      z-index:12 !important;
    }
    .fusion-card.active{opacity:1;transform:translateY(0) scale(1);}
    
    /* CORREÇÃO DO CARD "MINIFICADO" (CLOSED) - Removendo altura extra */
    .fusion-card.closed{width:260px; padding:14px 16px; border-radius:22px;}
    .fusion-card.closed .card-body { display: none; } /* Oculta corpo para evitar espaço vazio */

    .fusion-card.orb{ position: fixed !important; width: 68px !important; height: 68px !important; padding:0 !important; border-radius:50% !important; align-items:center; justify-content:center; box-shadow:0 15px 40px rgba(0,0,0,0.6), 0 0 20px rgba(0,242,255,0.2); z-index:9999; cursor:grab }
    .fusion-card.hud{ position: fixed !important; top: 12px !important; left: 50% !important; transform: translateX(-50%) !important; width: 92% !important; max-width:600px !important; height:64px !important; padding:0 16px !important; border-radius:99px !important; flex-direction:row; align-items:center; justify-content:space-between; box-shadow:0 10px 30px rgba(0,0,0,0.5); z-index:9999; }
    
    .card-header{display:flex;align-items:center;gap:15px;margin-bottom:18px; width:100%; cursor:pointer;}
    .avatar-slot{width:64px;height:64px;border-radius:18px;overflow:hidden;opacity:0;transition:opacity 0.35s}
    .avatar-slot.shown{opacity:1 !important;}
    
    .text-block{flex:1;display:flex;flex-direction:column;justify-content:center}
    .greeting-row{font-size:1.5rem;line-height:1;display:flex;align-items:baseline;gap:6px;flex-wrap:wrap; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .txt-thin{font-weight:200;color:rgba(255,255,255,0.7)}
    .txt-heavy{font-weight:600;color:#fff; max-width: 220px; display:inline-block; vertical-align:middle; font-size:1.05rem;}
    
    .brand-dual{font-size:2.2rem;font-weight:900;line-height:0.95;text-transform:uppercase;letter-spacing:-2px;margin-top:4px;background:linear-gradient(-45deg,#fff,var(--neon-cyan),var(--neon-purple),#fff);background-size:300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradientFlow 4s ease infinite}
    @keyframes gradientFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    
    .card-body{display:flex;flex-direction:column;gap:12px}
    .stagger-item{opacity:0;transform:translateY(15px);transition:opacity 0.4s ease, transform 0.4s var(--ease-overshoot)}
    .content-visible .stagger-item{opacity:1;transform:translateY(0)}
    
    .cyber-input{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:16px 50px 16px 18px;color:#fff;font-family:var(--font-code);font-size:0.9rem; outline: none;}
    .activation-pre{font-family:var(--font-code);white-space:pre-wrap;margin:0;padding:8px;background:rgba(0,0,0,0.12);border-radius:8px;border:1px dashed rgba(255,255,255,0.03);color:#fff;font-size:0.75rem}
    
    .small-preview{display:none;align-items:center;gap:10px;margin-top:8px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-family:var(--font-code);font-size:0.86rem;color:rgba(255,255,255,0.9);cursor:pointer;}
    .small-preview .mini-avatar{width:30px;height:30px;border-radius:6px;flex-shrink:0;overflow:hidden;display:inline-flex;align-items:center;justify-content:center}
    .small-preview .small-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 110px)}
    .small-preview .ident-badge{margin-left:auto;font-weight:700;font-size:0.78rem;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.02)}
    
    .trigger-btn{width:100%;padding:12px;border:1px dashed rgba(255,255,255,0.1);border-radius:12px;background:rgba(255,255,255,0.02);color:rgba(255,255,255,0.5);font-size:0.75rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px}
    
    /* Stats grid */
    .stats-grid { display: flex; justify-content: space-between; margin-top: 10px; }
    .stat-box { display: flex; flex-direction: column; align-items: center; }
    .stat-lbl { font-size: 0.6rem; color: rgba(255,255,255,0.4); letter-spacing: 1px; }
    .stat-val { font-size: 0.85rem; font-weight: 700; color: #fff; margin-top: 4px; }
    .progress-container { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; position: relative; }
    .bar-meta { display: flex; justify-content: space-between; font-size: 0.65rem; color: rgba(255,255,255,0.5); margin-bottom: 4px; }
    .bar-fill { height: 100%; background: var(--neon-cyan); width: 0%; transition: width 1s linear; }

    .toaster-wrap{position:fixed;right:20px;bottom:20px;z-index:99999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toaster{pointer-events:auto;background:linear-gradient(180deg,#0b1220,#071018);border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.6);font-family:var(--font-ui);font-size:0.95rem;opacity:0;transform:translateY(8px);transition:all 260ms var(--ease-smooth); color: #fff;}
    .toaster.show{opacity:1;transform:translateY(0)}
    .toaster.error{border-color:var(--neon-danger);color:var(--neon-danger)}
    .toaster.success{border-color:var(--neon-success);color:var(--neon-success)}

    /* Keys modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:99998;backdrop-filter:blur(8px)}
    .keys-card{width:90%;max-width:760px;background:linear-gradient(180deg,#071018,#0b1220);border:1px solid rgba(255,255,255,0.08);padding:20px;border-radius:16px;color:var(--text);box-shadow:0 20px 50px rgba(0,0,0,0.8);max-height:90vh;display:flex;flex-direction:column}
    .key-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding-right:6px;min-height:100px; margin: 15px 0;}
    .key-item{display:flex;align-items:center;gap:8px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02); justify-content: space-between;}
    .key-item.active-item{background:rgba(0, 242, 255, 0.05);border-color:rgba(0, 242, 255, 0.2)}
    .small-btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);padding:6px 10px;border-radius:8px;color:#fff;cursor:pointer;font-size:0.75rem;text-transform:uppercase;font-weight:600;transition:0.2s}
    .small-btn.active-btn{background:var(--neon-success);color:#000;border:none}
    .small-btn.danger{ color: var(--neon-danger); border-color: rgba(255,42,109,0.3); }
    .form-grid{display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;}
    .form-row{display: flex; gap: 8px;}
    .form-section input { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; outline: none; }

    /* Activation Card */
    .activation-hidden { display: none; }
    .activation-open { display: block; animation: fadeIn 0.3s ease; }
    .activation-toggle { cursor: pointer; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; }
    .activation-card { padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 8px; }
    .activation-controls { display: flex; gap: 8px; margin-top: 8px; }

    /* Responsive */
    @media (max-width:640px){
      .box{max-width:92%}
      .svg-container{width:120px;height:120px}
      .form-grid{grid-template-columns:1fr}
    }
  </style>
<style>
        :root {
          --z-base: 0;
          --z-content: 100;
          --z-widget: 500;
          --z-overlay: 1000;
          --z-system: 5000;
        }
      </style><link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;500;600;800&amp;family=JetBrains+Mono:wght@400;700&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"><style>
    /* --- ARCHITECTURE: DESIGN TOKENS --- */
    :root {
      /* DARK MODE (DEFAULT) */
      --bg-void: #020202;
      --bg-panel: #0a0a0c;
      
      --glass-surface: rgba(20, 20, 25, 0.7);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.03);
      --glass-shadow: rgba(0, 0, 0, 0.9);
      
      --neon-cyan: #00f2ff;
      --neon-purple: #bd00ff;
      --alert-red: #ff4d4d;
      
      --text-main: #e5e7eb;
      --text-muted: #6b7280;
      
      --font-ui: 'Inter', sans-serif;
      --font-code: 'JetBrains Mono', monospace;
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 24px;
      
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* LIGHT MODE (FROST PROTOCOL) */
    :root[data-theme="light"] {
      --bg-void: #eef2f6;
      --bg-panel: #ffffff;
      
      --glass-surface: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(0, 0, 0, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.4);
      --glass-shadow: rgba(0, 0, 0, 0.1);
      
      --neon-cyan: #008088; /* Darker Teal for contrast */
      --neon-purple: #8a00bc;
      --alert-red: #dc2626;
      
      --text-main: #111827;
      --text-muted: #64748b;
    }

    /* --- RESET & BASE --- */
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    
    body {
      background-color: var(--bg-void);
      color: var(--text-main);
      font-family: var(--font-ui);
      overflow: hidden;
      height: 100vh; width: 100vw;
      transition: background-color 0.4s ease, color 0.4s ease;
    }

    /* --- UTILITIES --- */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    
    .state-translated-x { transform: translateX(100%); }
    .state-visible-y { transform: translateY(0) !important; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.3); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }

    /* --- LAYERS --- */

    /* Layer 0: Ambient */
    .void-ambient {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background: radial-gradient(circle at 50% 120%, var(--glass-highlight), transparent 60%);
      opacity: 0.1; transition: opacity 0.4s;
    }

    /* Layer 1: Nav Frame */
    #navFrame {
      position: fixed; inset: 0; width: 100%; height: 100%; border: 0; z-index: 0;
    }

    /* Layer 2: UI Overlays */
    .top-bar {
      position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 40;
      display: flex; align-items: center; gap: 1rem;
      background: var(--glass-surface); backdrop-filter: blur(12px);
      padding: 0.5rem 1rem; border-radius: 99px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 20px -5px var(--glass-shadow);
      transition: all 0.4s;
    }
    .brand-text { font-family: var(--font-code); font-size: 0.75rem; color: var(--text-muted); letter-spacing: 2px; }
    .sep { height: 12px; width: 1px; background: var(--text-muted); opacity: 0.3; }
    .theme-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; transition: color 0.3s; }
    .theme-btn:hover { color: var(--text-main); }

    /* Sidebars */
    .sidebar {
      position: fixed; top: 50%; transform: translateY(-50%); z-index: 40;
      display: flex; flex-direction: column; gap: 0.5rem;
    }
    .sidebar.right { right: 0.75rem; }
    .sidebar.left { left: 0.75rem; }

    .icon-btn {
      width: 2rem; height: 2rem; border-radius: var(--radius-sm);
      background: var(--glass-surface); border: 1px solid var(--glass-border);
      color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; backdrop-filter: blur(4px);
    }
    .icon-btn:hover { background: var(--glass-highlight); color: var(--text-main); border-color: var(--text-muted); }
    
    .nav-btn { color: var(--neon-cyan); font-family: var(--font-code); font-size: 0.9rem; }
    .nav-btn:hover { background: var(--neon-cyan); color: var(--bg-void); box-shadow: 0 0 12px var(--neon-cyan); }

    /* --- MONOLITH --- */
    .monolith-wrapper {
      position: fixed; inset: 0; z-index: 50;
      display: flex; align-items: center; justify-content: center;
      padding: 1rem; pointer-events: none;
      perspective: 1200px;
    }

    .monolith {
      width: 100%; max-width: 64rem; height: 80vh; max-height: 850px;
      background: var(--glass-surface);
      backdrop-filter: blur(30px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      box-shadow: 0 40px 80px -12px var(--glass-shadow);
      
      display: flex; flex-direction: column; position: relative; overflow: hidden;
      
      /* 3D State: Inactive */
      opacity: 0; transform: translateY(60px) rotateX(10deg) scale(0.95); transform-style: preserve-3d;
      transition: all 0.6s var(--ease-out-expo);
    }

    /* 3D State: Active */
    body.system-active .monolith {
      opacity: 1; transform: translateY(0) rotateX(0) scale(1); pointer-events: auto;
    }

    /* Monolith Internals */
    .mono-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 1.5rem; border-bottom: 1px solid var(--glass-border);
      background: var(--glass-highlight);
    }
    .mono-brand { display: flex; align-items: center; gap: 0.75rem; }
    .brand-icon { 
      width: 2rem; height: 2rem; background: rgba(128,128,128,0.1); 
      border: 1px solid var(--glass-border); border-radius: 6px;
      display: flex; align-items: center; justify-content: center; color: var(--neon-cyan);
    }
    .brand-title { font-weight: 700; font-size: 0.875rem; letter-spacing: 0.05em; color: var(--text-main); }
    
    .status-badge {
      font-family: var(--font-code); font-size: 10px; padding: 3px 8px;
      border-radius: 4px; background: rgba(128,128,128,0.1); border: 1px solid var(--glass-border);
      color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; transition: all 0.3s;
    }

    .mono-body { flex: 1; display: flex; position: relative; overflow: hidden; }

    /* View: Vault */
    .vault-view {
      width: 100%; height: 100%; padding: 1.5rem; overflow-y: auto;
      display: flex; flex-direction: column;
    }

    .actions-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;
    }
    @media (min-width: 768px) { .actions-grid { grid-template-columns: repeat(4, 1fr); } }

    .action-card {
      padding: 1rem; border-radius: var(--radius-md); border: 1px solid var(--glass-border);
      background: rgba(128,128,128,0.05); color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.8rem;
      transition: all 0.2s; font-weight: 500;
    }
    .action-card:hover { background: var(--glass-highlight); color: var(--text-main); border-color: var(--text-muted); }
    
    .btn-create { background: var(--neon-cyan); color: var(--bg-void); border: none; font-weight: 700; }
    .btn-create:hover { background: var(--text-main); color: var(--bg-void); box-shadow: 0 0 20px rgba(128,128,128,0.2); }

    .action-card.dashed { border-style: dashed; border-color: var(--text-muted); opacity: 0.7; }
    .action-card.dashed:hover { border-color: var(--neon-cyan); color: var(--text-main); background: rgba(128,128,128,0.05); opacity: 1; }

    .list-header { display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding: 0 4px; }
    .list-label { font-size: 0.7rem; font-family: var(--font-code); color: var(--text-muted); letter-spacing: 0.5px; }

    .stack-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.75rem; margin-bottom: 0.5rem;
      background: rgba(128,128,128,0.03); border: 1px solid var(--glass-border);
      border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s;
    }
    .stack-item:hover { border-color: var(--neon-cyan); background: var(--glass-highlight); transform: translateX(4px); }
    
    .stack-info { display: flex; align-items: center; gap: 0.75rem; overflow: hidden; }
    .stack-icon { 
      width: 2rem; height: 2rem; border-radius: 6px; background: rgba(128,128,128,0.1); 
      display: flex; align-items: center; justify-content: center; color: var(--neon-cyan); opacity: 0.7;
    }
    .stack-item:hover .stack-icon { opacity: 1; color: var(--neon-cyan); background: rgba(128,128,128,0.2); }
    .stack-text h4 { font-size: 0.85rem; font-weight: 500; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stack-text span { font-size: 0.65rem; font-family: var(--font-code); color: var(--text-muted); }

    .stack-actions { display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s; }
    .stack-item:hover .stack-actions { opacity: 1; }
    
    .mini-btn { width: 2rem; height: 2rem; border-radius: 6px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .btn-run { background: var(--neon-cyan); color: var(--bg-void); }
    .btn-run:hover { background: var(--text-main); color: var(--bg-void); }
    .btn-del { border: 1px solid rgba(255, 77, 77, 0.2); background: transparent; color: var(--alert-red); }
    .btn-del:hover { background: var(--alert-red); color: white; border-color: var(--alert-red); }

    /* View: Editor */
    .editor-view {
      position: absolute; inset: 0; z-index: 10;
      background: var(--bg-panel); padding: 1.5rem;
      display: flex; flex-direction: column;
      transition: transform 0.5s var(--ease-out-expo);
    }
    
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .editor-title { color: var(--neon-cyan); font-family: var(--font-code); font-size: 0.8rem; letter-spacing: 1px; }
    .btn-cancel { background: rgba(128,128,128,0.1); color: var(--text-muted); border: none; padding: 4px 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; transition: 0.2s; }
    .btn-cancel:hover { background: rgba(128,128,128,0.2); color: var(--text-main); }

    .input-title {
      width: 100%; background: rgba(128,128,128,0.05); border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm); padding: 0.75rem; margin-bottom: 0.75rem;
      color: var(--text-main); font-family: var(--font-code); font-size: 0.8rem; transition: 0.2s;
    }
    .input-title:focus { border-color: var(--neon-cyan); background: var(--bg-panel); }
    
    .code-area {
      flex: 1; position: relative; border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm); overflow: hidden; background: rgba(0,0,0,0.2);
    }
    textarea#modContent {
      width: 100%; height: 100%; background: transparent; border: none; padding: 1rem;
      color: #a7f3d0; font-family: var(--font-code); font-size: 0.75rem; resize: none; line-height: 1.5;
    }
    /* Darken code text in light mode for readability */
    :root[data-theme="light"] textarea#modContent { color: #065f46; background: rgba(255,255,255,0.5); }

    .btn-save {
      width: 100%; margin-top: 1rem; padding: 0.75rem;
      background: var(--neon-cyan); color: var(--bg-void); border: none; border-radius: var(--radius-md);
      font-weight: 700; cursor: pointer; transition: all 0.2s;
    }
    .btn-save:hover { background: var(--text-main); color: var(--bg-void); box-shadow: 0 0 15px rgba(128,128,128,0.2); }

    /* Runtime Layer */
    .runtime-layer {
      position: absolute; inset: 0; z-index: 20; background: black; /* Always dark for cinema mode */
      display: flex; flex-direction: column;
      transform: translateY(100%); transition: transform 0.5s var(--ease-out-expo);
    }
    
    .runtime-bar {
      height: 2.5rem; background: #0a0a0c; border-bottom: 1px solid #333;
      display: flex; align-items: center; justify-content: space-between; padding: 0 1rem;
    }
    .runtime-indicator { display: flex; align-items: center; gap: 0.5rem; font-family: var(--font-code); font-size: 0.7rem; color: #00f2ff; letter-spacing: 0.5px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: #00f2ff; animation: pulse 2s infinite; }
    
    .runtime-frame-wrap { flex: 1; position: relative; background: white; }
    .scanline {
      position: absolute; inset: 0; pointer-events: none; opacity: 0.15; mix-blend-mode: overlay;
      background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.2) 50%); background-size: 100% 4px;
    }

    /* Footer Pulse */
    .mono-footer { height: 2px; width: 100%; background: var(--bg-panel); position: relative; overflow: hidden; margin-top: auto; }
    #pulseBar {
      position: absolute; inset: 0; width: 50%;
      background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
      animation: scan 3s linear infinite; opacity: 0; transition: opacity 0.3s;
    }

    @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* --- ORB TRIGGER --- */
    .orb-container {
      position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 60;
      transition: all 0.5s var(--ease-out-expo);
    }
    
    .orb-btn {
      width: 2.75rem; height: 2.75rem; 
      border-radius: 50%; border: none; cursor: pointer;
      background: var(--glass-surface); backdrop-filter: blur(8px);
      box-shadow: 0 0 0 1px var(--glass-border), 0 0 20px rgba(0,0,0,0.1);
      position: relative; display: flex; align-items: center; justify-content: center;
      transition: 0.3s;
    }
    .orb-btn:hover { box-shadow: 0 0 0 1px var(--neon-cyan), 0 0 30px var(--neon-cyan); }
    
    .orb-core { 
      width: 6px; height: 6px; background: var(--text-main); border-radius: 50%; 
      box-shadow: 0 0 10px var(--glass-highlight); transition: 0.3s; 
    }
    .orb-btn:hover .orb-core { background: var(--neon-cyan); box-shadow: 0 0 15px var(--neon-cyan); transform: scale(1.1); }
    
    .orb-ring { 
      position: absolute; inset: 3px; border-radius: 50%; 
      border: 1px solid transparent; border-top-color: var(--neon-cyan); 
      animation: spin 6s linear infinite; opacity: 0.6; 
    }
    .orb-ring.inner { 
      inset: 8px; border-top-color: transparent; border-bottom-color: var(--neon-purple); 
      animation-direction: reverse; opacity: 0.5; animation-duration: 8s; 
    }

    /* --- TOAST --- */
    #toast {
      position: fixed; top: 4rem; left: 50%; transform: translateX(-50%);
      padding: 0.5rem 1rem; border-radius: var(--radius-sm);
      background: rgba(0,0,0,0.9); border: 1px solid var(--neon-cyan);
      color: var(--neon-cyan); font-family: var(--font-code); font-size: 0.75rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 100;
      transition: all 0.4s var(--ease-out-expo);
      pointer-events: none; opacity: 1;
    }
    
    #toast.toast-hidden { opacity: 0; transform: translate(-50%, -10px); }

  </style></head>
<body>

  <!-- ALERT OVERRIDE (For Preview Safety) -->
  <script>
    // Map default alert/confirm to safer implementations or console to prevent blocking
    const originalAlert = window.alert;
    window.alert = function(msg) {
        if(typeof showToaster === 'function') {
            showToaster(msg, 'default');
        } else {
            console.log("ALERT:", msg);
            // Fallback simple UI
            const d = document.createElement('div');
            d.style.cssText = "position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(10,10,15,0.95);color:#fff;padding:12px 24px;border-radius:99px;z-index:999999;border:1px solid rgba(255,255,255,0.1);box-shadow:0 5px 20px rgba(0,0,0,0.5);font-family:sans-serif;font-size:0.9rem;pointer-events:none;animation:fadeIn 0.3s ease;";
            d.textContent = msg;
            document.body.appendChild(d);
            setTimeout(()=> { d.style.opacity='0'; setTimeout(()=>d.remove(),300) }, 3000);
        }
    };
  </script>

  <!-- PARTICLES + AMBIENT BLOBS -->
  <div id="particles-js"><canvas class="particles-js-canvas-el"></canvas></div>
  <div class="ambient-light"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

  <!-- SVG central (chat) - RESTORED OBJECT TAG -->
  <div class="svg-container" style="z-index:3">
    <object data="3D_logo_Dual_Infodose_9.svg" type="image/svg+xml"></object>
  </div>

  <!-- TOP INFO (chat) -->
  <div class="top-info" id="topInfo" style="z-index:5">
    <span id="displayUser">User: —</span> · <span id="displayInfodose">Infodose: —</span>
  </div>

  <!-- RESPONSE container (chat) -->
  <div class="response-container" id="response" style="z-index:4">
    <div class="page initial active">
      <strong>Clique no ◉ e diga “Oi, Dual”.</strong><br>
      <em>Sempre único. Sempre seu.</em>
    </div>

    <div class="response-controls">
      <div class="control-buttons">
        <button class="control-btn copy-button" title="Copiar tudo">
          <svg viewBox="0 0 24 24" width="20" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
        <button class="control-btn paste-button" title="Colar">
           <svg viewBox="0 0 24 24" width="20" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
        </button>
        <button id="toggleBtn" class="control-btn toggle-button" title="Painel Infodose">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
        <button id="crystalBtn" class="control-btn" title="Cristalizados">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" fill="none" stroke-width="2"><path d="M12 2l2.9 6.3L21 10l-5 3.6L17.8 21 12 17.7 6.2 21 7 13.6 2 10l6.1-1.7L12 2z"></path></svg>
        </button>
        <button id="settingsBtn" class="control-btn" title="Configurações">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" fill="none" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
      </div>

      <div class="pagination">
        <button data-action="prev">⟵</button>
        <span id="pageIndicator">1 / 1</span>
        <button data-action="next">⟶</button>
      </div>
    </div>
  </div>

  <!-- INPUT (chat) -->
  <div class="input-container" style="z-index:5">
    <input id="userInput" type="text" placeholder="Diga: 'oi, Dual'...">
    <button id="sendBtn" title="Enviar">➤</button>
    <button id="voiceBtn" title="Falar">
      <!-- RESTORED OBJECT TAG -->
      <object data="Reset_buttom_Dual-Infodose.svg" type="image/svg+xml" width="36" height="36" style="pointer-events: none;"></object>
    </button>
  </div>

  <!-- Settings Modal (chat) -->
  <div id="settingsModal" class="modal">
    <div class="box">
      <h3>Configuração Neural</h3>
      <div class="col">
        <div class="input-group">
          <label>OpenRouter API Key (SK)</label>
          <input type="password" id="apiKeyInput" placeholder="sk-or-..." autocomplete="off">
        </div>
        <div class="input-group">
          <label>Modelo AI</label>
          <input type="text" id="modelInput" placeholder="ex: meta-llama/llama-3.1-405b-instruct:free">
        </div>
        <div class="settings-actions">
          <button id="cancelSettings" class="btn btn-sec">Cancelar</button>
          <button id="saveSettings" class="btn btn-prim">Salvar Conexão</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toggle Panel (chat) -->
  <div id="togglePanel" class="panel">
    <div class="box">
      <h3>Painel Infodose</h3>
      <div class="row">
        <div style="flex:1" class="col">
          <label class="small">Usuário</label>
          <input type="text" id="userNameInput" placeholder="Seu nome...">
        </div>
        <div style="flex:1" class="col">
          <label class="small">Nome da Infodose</label>
          <input type="text" id="infodoseNameInput" placeholder="Ex: World System — Alpha">
        </div>
      </div>

      <div style="margin-top:10px" class="col">
        <label class="small">Treinamento (World System) — Upload / Export</label>
        <input type="file" id="trainingUpload" accept=".txt">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="importTrainingBtn" class="btn btn-sec">Importar (ler)</button>
          <button id="exportTrainingBtn" class="btn btn-prim">Exportar treino</button>
        </div>
        <div id="trainingFileName" class="small" style="margin-top:6px;color:#9bd">Nenhum arquivo carregado</div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <label class="small" style="flex:1">Infodose ativa</label>
        <input type="checkbox" id="assistantActiveCheckbox">
        <label class="small" style="flex:1">Treinamento ativo</label>
        <input type="checkbox" id="trainingActiveCheckbox">
      </div>

      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="savePanelBtn" class="btn btn-prim">Salvar Painel</button>
        <button id="closePanelBtn" class="btn btn-sec">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Crystal modal (chat) -->
  <div id="crystalModal" class="modal">
    <div class="box">
      <h3>Cristalizados</h3>
      <div class="row" style="margin-bottom:8px">
        <button id="exportAllCrystal" class="btn btn-prim">Exportar todos</button>
        <button id="clearAllCrystal" class="btn btn-sec">Limpar tudo</button>
      </div>
      <div class="crystal-list" id="crystalList"></div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
        <button id="closeCrystal" class="btn btn-sec">Fechar</button>
      </div>
    </div>
  </div>

  <!-- MANTRA FOOTER -->
  <div id="mantra-toggle" style="z-index:5">
    <span id="mantra-text">
      Do seu jeito. <strong>Sempre</strong> único. <strong>Sempre</strong> seu.
    </span>
  </div>

  <!-- Fusion HUD Card -->
  <div class="container">
    <div class="fusion-card closed" id="mainCard" role="application" aria-label="Fusion HUD">
      <div class="card-header" id="cardHeader">
        <div class="avatar-slot" id="avatarTarget" title="Gerenciar Chaves"></div>
        <div class="text-block">
          <div class="greeting-row">
            <span class="txt-thin" id="lblHello">Oi,</span>
            <span class="txt-heavy" id="lblName">Convidado</span>
          </div>
          <div class="brand-dual">DUAL</div>
        </div>
        <div class="clock-widget">
          <div class="time-display" id="clockTime" style="font-family: var(--font-code); color:var(--neon-cyan);">00:00</div>
          <span class="status-led" style="font-size:0.6rem; letter-spacing:1px; color:rgba(255,255,255,0.4)">ONLINE</span>
        </div>
      </div>

      <div class="small-preview" id="smallPreview" title="Gerenciar Chaves">
        <div class="mini-avatar" id="smallMiniAvatar"></div>
        <div class="small-text" id="smallText">Aguardando ativação...</div>
        <div class="ident-badge" id="smallIdent">--</div>
      </div>

      <div class="card-body" id="cardBody">
        <div class="input-wrapper stagger-item">
          <input type="text" class="cyber-input" id="inputUser" placeholder="Identifique-se..." autocomplete="off">
        </div>

        <div class="activation-wrap stagger-item">
          <div class="activation-toggle" onclick="toggleActivation()">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:10px;height:10px;border-radius:99px;background:var(--neon-cyan)"></div>
              <strong style="letter-spacing:1px;font-size:0.9rem">Ativação ASCII</strong>
            </div>
            <div style="margin-left:auto;font-size:0.82rem;color:rgba(255,255,255,0.6)">BASE v1</div>
          </div>
          <div id="activationCard" class="activation-card activation-hidden">
            <div style="display:flex;align-items:flex-start;gap:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <div class="mini-avatar" id="actMiniAvatar"></div>
                <div><div style="font-weight:700">CÉREBRO</div><div style="font-size:0.78rem;opacity:0.6"><span id="actName">User</span></div></div>
              </div>
              <div class="activation-badge" id="actBadge" style="margin-left:auto; font-size:0.7rem; color: #888;">v:--</div>
            </div>
            <pre id="actPre" class="activation-pre">Carregando...</pre>
            <div class="activation-controls">
              <button class="trigger-btn" id="copyActBtn">COPIAR</button>
              <button class="trigger-btn" id="downloadActBtn">PNG</button>
            </div>
          </div>
        </div>

        <div class="stagger-item">
          <div class="stats-grid">
            <div class="stat-box"><span class="stat-lbl">LATÊNCIA</span><span class="stat-val">12ms</span></div>
            <div class="stat-box"><span class="stat-lbl">SEGURANÇA</span><span class="stat-val" id="securityStatus">ABERTO</span></div>
            <div class="stat-box"><span class="stat-lbl">RITMO</span><span class="stat-val">BETA</span></div>
          </div>
          <div class="progress-container" style="margin-top:12px">
            <div class="bar-meta"><span>CICLO DIÁRIO</span><span id="cyclePercent">0%</span></div>
            <div class="bar-track"><div class="bar-fill" id="cycleFill"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toaster -->
  <div class="toaster-wrap" id="toasterWrap"></div>

  <!-- Keys Modal (fusion) -->
  <div id="keysModal" class="modal-overlay" aria-hidden="true">
    <div class="keys-card" role="dialog">
      <div class="keys-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>
          <div id="keysTitle" style="font-weight:800;font-size:1.1rem;color:var(--neon-cyan)">USER KEYS MANAGER</div>
          <div style="color:rgba(255,255,255,0.6);font-size:0.85rem">Gerencie suas ESK Keys com segurança local.</div>
        </div>
        <button id="closeKeysBtn" class="small-btn">X</button>
      </div>

      <div class="key-list" id="keyList"></div>

      <div class="form-section">
        <div class="form-grid">
          <input id="keyNameInput" placeholder="Nome da chave (ex: Principal)">
          <input id="keyTokenInput" type="password" placeholder="Token / ESK (Opcional)">
        </div>
        <div class="form-row">
          <input id="keyWebhookInput" placeholder="Webhook URL (https://...)" style="flex:1">
          <button id="testWebhookBtn" class="small-btn" title="Testar Conexão">PING</button>
        </div>
        <button id="addKeyBtn" class="small-btn" style="width:100%;margin-top:8px;background:rgba(255,255,255,0.1)">ADICIONAR CHAVE</button>
      </div>

      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:15px;border-top:1px solid rgba(255,255,255,0.05);padding-top:12px">
        <div style="font-size:0.7rem;color:rgba(255,255,255,0.4);display:flex;align-items:center;gap:5px">
          <i data-lucide="shield-check" style="width:14px"></i> <span id="vaultStatusText">Cofre Aberto</span>
        </div>
        <div style="display:flex;gap:8px">
          <button id="lockVaultBtn" class="small-btn danger">BLOQUEAR</button>
          <button id="exportKeysBtn" class="small-btn">Export</button>
          <button id="importKeysBtn" class="small-btn">Import</button>
          <input id="importFileInput" type="file" accept="application/json" style="display:none">
        </div>
      </div>
    </div>
  </div>

  <!-- Vault Modal -->
  <div id="vaultModal" class="modal-overlay" aria-hidden="true">
    <div class="keys-card">
      <div class="vault-icon" style="text-align:center; margin-bottom:10px;"><i data-lucide="lock" style="width:32px;height:32px; color:var(--neon-gold)"></i></div>
      <h3 style="margin:0 0 10px 0;font-weight:800; text-align:center;">ACESSO AO COFRE</h3>
      <p style="margin:0 0 15px 0;font-size:0.9rem;color:rgba(255,255,255,0.6); text-align:center;">Seus dados estão criptografados. Digite a senha para desbloquear.</p>
      <input type="password" id="vaultPassInput" class="cyber-input" style="text-align:center;margin-bottom:12px" placeholder="Senha...">
      <div style="display:flex;gap:8px;justify-content:center">
         <button id="vaultCancelBtn" class="small-btn">Cancelar</button>
         <button id="vaultUnlockBtn" class="small-btn active-btn">DESBLOQUEAR</button>
      </div>
    </div>
  </div>

  <!-- Scripts: Chat (keeps globals expected by sync patch) -->
  <script>
    /* ---------- Constantes iniciais (Chat module - globals intentionally) ---------- */
    const TRAINING_FILE_FALLBACK = 'Super_Treinamento_Universal_Dual_Infodose_v1-28.txt';
    const API_ENDPOINT = 'https://openrouter.ai/api/v1/chat/completions';
    const TEMPERATURE = 0.2;

    // estado (global; sync patch depends on these names)
    let training = '';
    let trainingFileName = '';
    let assistantEnabled = false;
    let trainingActive = true; // se false, não inclui 'system' no conversation
    let conversation = [];
    let pages = [], currentPage = 0, autoAdvance = true;

    // configs persistidas (globals)
    let apiKey = localStorage.getItem('di_apiKey') || '';
    let modelName = localStorage.getItem('di_modelName') || 'meta-llama/llama-3.1-405b-instruct:free';
    let userName = localStorage.getItem('di_userName') || '';
    let infodoseName = localStorage.getItem('di_infodoseName') || '';
    const CRYSTAL_KEY = 'di_cristalizados';

    const createEl = (tag, cls, html) => { const e = document.createElement(tag); if (cls) e.className = cls; if (html) e.innerHTML = html; return e; };
    const splitBlocks = text => {
      if (!text || !text.trim()) return [['Sem conteúdo de treinamento.','','']];
      let paras = text.split(/\n\s*\n/).filter(p=>p.trim());
      if (paras.length % 3 !== 0) {
        const sens = paras.join(' ').match(/[^\.!\?]+[\.!\?]+/g) || [paras.join(' ')];
        paras = sens.map(s=>s.trim());
      }
      const groups = [];
      for (let i=0;i<paras.length;i+=3) groups.push(paras.slice(i,i+3));
      return groups;
    };

    // TTS
    const speakText = (txt, onend)=> {
      if (!txt) { if (onend) onend(); return; }
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = 'pt-BR'; u.rate = 0.99; u.pitch = 1.1; u.volume = 1;
      if (window._vozes) u.voice = window._vozes.find(v=>v.lang==='pt-BR') || window._vozes[0];
      if (onend) u.onend = onend;
      speechSynthesis.speak(u);
    };

    const updateTopInfo = () => {
      const du = document.getElementById('displayUser');
      const di = document.getElementById('displayInfodose');
      if (du) du.innerText = 'User: ' + (userName || '—');
      if (di) di.innerText = 'Infodose: ' + (infodoseName || '—');
    };

    const updateToggleUI = () => {
      const tb = document.getElementById('toggleBtn');
      if (tb) tb.classList.toggle('active', assistantEnabled);
      const as = document.getElementById('assistantActiveCheckbox');
      const tr = document.getElementById('trainingActiveCheckbox');
      if (as) as.checked = !!assistantEnabled;
      if (tr) tr.checked = !!trainingActive;
    };

    async function loadInitialTraining() {
      const localTraining = localStorage.getItem('di_trainingText');
      const localFileName = localStorage.getItem('di_trainingFileName') || '';
      if (localTraining) {
        training = localTraining;
        trainingFileName = localFileName;
        const tf = document.getElementById('trainingFileName');
        if (tf) tf.innerText = localFileName || 'treinamento (local)';
        return;
      }
      try {
        const r = await fetch(TRAINING_FILE_FALLBACK);
        if (r.ok) {
          training = await r.text();
          trainingFileName = TRAINING_FILE_FALLBACK;
          const tf = document.getElementById('trainingFileName');
          if (tf) tf.innerText = TRAINING_FILE_FALLBACK;
        }
      } catch (e) { /* silent */ }
    }

    /* === Markdown-enabled paginated renderer === */
const md = window.markdownit({
  html: false,         // desativa HTML cru; se quiser permitir HTML, mude para true
  linkify: true,
  typographer: true
});

const renderPaginatedResponse = text => {
  speechSynthesis.cancel();
  autoAdvance = true;
  const respEl = document.getElementById('response');
  if (!respEl) return;
  respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
  pages = [];
  const groups = splitBlocks(text);
  const titles = ['🎁 Recompensa Inicial','👁️ Exploração e Curiosidade','⚡ Antecipação Vibracional'];

  // toggle sanitization
  const useSanitize = true; // <<== false se preferir não usar DOMPurify

  groups.forEach((tris, gi) => {
    const page = createEl('div', gi===0?'page active':'page');
    tris.forEach((body, j) => {
      const cls = j===0?'intro': j===1?'middle':'ending';
      // render markdown -> html
      let rendered = md.render(body || '');
      if (useSanitize && window.DOMPurify) rendered = DOMPurify.sanitize(rendered);
      // create block container
      const b = createEl('div','response-block '+cls, `
        <div class="markdown-body">${rendered}</div>
      `);

      // meta & actions
      const meta = createEl('div','meta');
      const crystalBtn = createEl('button','crystal-btn','✶');
      crystalBtn.title = 'Cristalizar essa mensagem';
      crystalBtn.addEventListener('click',(ev)=>{ ev.stopPropagation(); cristalizar({ title: titles[j], content: body }); crystalBtn.innerText='✓'; setTimeout(()=> crystalBtn.innerText='✶',1200); });
      meta.appendChild(crystalBtn);
      b.appendChild(meta);

      // block-level actions bottom-left (copy)
      const actions = createEl('div','block-actions');
      const copyBtn = createEl('button','copy-block-btn','Copiar');
      copyBtn.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        // prefer copying original markdown; but copy rendered plain text if needed
        navigator.clipboard.writeText(body || b.innerText).then(()=> showToaster('Bloco copiado','success'));
      });
      actions.appendChild(copyBtn);
      b.appendChild(actions);

      // click behavior: speak / expand / callAI (mantendo tua lógica)
      b.dataset.state = '';
      b.addEventListener('click', () => {
        if (!b.dataset.state) {
          speechSynthesis.cancel();
          // pega texto plano (sem tags)
          const plain = Array.from(b.querySelectorAll('p, li')).map(n => n.innerText).join(' ');
          speakText(plain);
          b.classList.add('clicked');
          b.dataset.state = 'spoken';
        } else {
          b.classList.add('expanded');
          b.dataset.state = '';
          if (!assistantEnabled) {
            assistantEnabled = true;
            localStorage.setItem('di_assistantEnabled','1');
            if (training && trainingActive) conversation.unshift({ role:'system', content: training });
            updateToggleUI();
          }
          const blockText = `${titles[j]}\n\n${body}`;
          showLoading('Pulso em Expansão...');
          speechSynthesis.cancel();
          speakText('Pulso em Expansão...');
          conversation.push({ role:'user', content: blockText });
          callAI();
        }
      });

      b.addEventListener('animationend', e => { if (e.animationName==='clickPulse') b.classList.remove('clicked'); });

      page.appendChild(b);
    });

    page.appendChild(createEl('p','footer-text',`<em>Do seu jeito. <strong>Sempre</strong> único. <strong>Sempre</strong> seu.</em>`));
    const controls = respEl.querySelector('.response-controls');
    if (controls) respEl.insertBefore(page, controls);
    pages.push(page);

    // after DOM insertion, highlight code blocks in this page
    setTimeout(()=> {
      try {
        page.querySelectorAll('pre code').forEach(el => { Prism.highlightElement(el); });
      } catch(e) {}
    }, 40);
  });

  currentPage = 0;
  const pi = document.getElementById('pageIndicator');
  if (pi) pi.textContent = `1 / ${pages.length}`;
  speakPage(0);
};

    const speakPage = i => {
      const page = pages[i];
      if (!page) return;
      const body = Array.from(page.querySelectorAll('.response-block p')).map(p=>p.innerText).join(' ');
      speakText(body, () => {
        if (!autoAdvance) return;
        if (i < pages.length - 1) {
          changePage(1);
          speakPage(i+1);
        } else {
          speakText('Do seu jeito, sempre único, sempre seu.');
        }
      });
    };
    const changePage = offset => {
      const np = currentPage + offset;
      if (np<0||np>=pages.length) return;
      pages[currentPage].classList.remove('active');
      pages[np].classList.add('active');
      currentPage = np;
      const pi = document.getElementById('pageIndicator');
      if (pi) pi.textContent = `${currentPage+1} / ${pages.length}`;
    };

    const showLoading = msg => {
      const respEl = document.getElementById('response');
      const controls = respEl.querySelector('.response-controls');
      respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
      const page = createEl('div','page active');
      page.appendChild(createEl('p','footer-text',msg));
      if (controls) respEl.insertBefore(page, controls);
      pages = [page];
      currentPage = 0;
      const pi = document.getElementById('pageIndicator');
      if (pi) pi.textContent = '…';
    };

    async function callAI() {
      if (!apiKey) {
        alert('Por favor, configure sua API Key no botão de configurações.');
        const sModal = document.getElementById('settingsModal');
        if (sModal) sModal.classList.add('active');
        return;
      }

      const bodyObj = { model: modelName, messages: conversation.slice(), temperature: TEMPERATURE };
      const messagesToSend = [];
      if (assistantEnabled && trainingActive && training) messagesToSend.push({ role:'system', content: training });
      conversation.forEach(m => {
        if (m.role === 'system') return;
        messagesToSend.push(m);
      });
      bodyObj.messages = messagesToSend;

      try {
        const resp = await fetch(API_ENDPOINT, {
          method:'POST',
          headers:{ 'Authorization':`Bearer ${apiKey}`, 'Content-Type':'application/json' },
          body: JSON.stringify(bodyObj)
        });
        if (!resp.ok) throw new Error('Erro API: ' + resp.status);
        const data = await resp.json();
        const answer = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content)
          ? data.choices[0].message.content.trim()
          : (data.result || 'Resposta vazia');
        conversation.push({ role:'assistant', content: answer });
        renderPaginatedResponse(answer);
      } catch (err) {
        console.error(err);
        const errorMsg = 'O pulso oscilou (Erro de Conexão ou Key inválida). Verifique as configurações.';
        conversation.push({ role:'assistant', content: errorMsg });
        renderPaginatedResponse(errorMsg);
      }
    }

    async function sendMessage(){
      const respEl = document.getElementById('response');
      const initPage = respEl ? respEl.querySelector('.page.initial') : null;
      if (initPage) initPage.remove();

      const input = document.getElementById('userInput');
      const raw = input ? input.value.trim() : '';
      if (!raw) return;
      if (input) input.value = '';

      speechSynthesis.cancel();
      speakText('');

      const txt = raw.toLowerCase();
      if (txt === 'oi dual' || txt === 'oi, dual') {
        assistantEnabled = true;
        localStorage.setItem('di_assistantEnabled','1');
        showLoading('Dual Infodose ativa. Pulso enviado...');
        if (training && trainingActive) conversation.unshift({ role:'system', content: training });
        updateToggleUI();
      } else {
        showLoading('⚡Pulso enviado...Recebendo Intenção…');
      }

      conversation.push({ role:'user', content: raw });
      callAI();
    }

    function cristalizar({ title, content }) {
      const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
      const item = {
        id: Date.now(),
        title: title,
        content: content,
        user: userName || '—',
        infodose: infodoseName || '—',
        at: new Date().toISOString()
      };
      list.unshift(item);
      localStorage.setItem(CRYSTAL_KEY, JSON.stringify(list));
      refreshCrystalList();
    }

    function refreshCrystalList() {
      const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
      const el = document.getElementById('crystalList');
      if (!el) return;
      el.innerHTML = '';
      if (!list.length) {
        el.innerHTML = '<div class="small">Nenhum cristalizado ainda.</div>';
        return;
      }
      list.forEach(it => {
        const row = createEl('div','crystal-item');
        const left = createEl('div','','<strong>'+ (it.title||'—') +'</strong><div class="small">'+(it.infodose || '')+' · '+(new Date(it.at)).toLocaleString()+'</div><div style="margin-top:6px">'+ (it.content.length>220 ? it.content.slice(0,220)+'...' : it.content) +'</div>');
        const actions = createEl('div','actions');
        const copyBtn = createEl('button','btn btn-sec','Copiar');
        copyBtn.addEventListener('click', ()=> { navigator.clipboard.writeText(it.content); });
        const exportBtn = createEl('button','btn btn-prim','Exportar');
        exportBtn.addEventListener('click', ()=> {
          const blob = new Blob([it.content], { type:'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `cristal_${it.id}.txt`; a.click(); URL.revokeObjectURL(url);
        });
        const delBtn = createEl('button','btn btn-sec','Apagar');
        delBtn.addEventListener('click', () => {
          const arr = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]').filter(x => x.id !== it.id);
          localStorage.setItem(CRYSTAL_KEY, JSON.stringify(arr));
          refreshCrystalList();
        });
        actions.appendChild(copyBtn); actions.appendChild(exportBtn); actions.appendChild(delBtn);
        row.appendChild(left); row.appendChild(actions);
        el.appendChild(row);
      });
    }

    function setupSettings() {
      const modal = document.getElementById('settingsModal');
      const btn = document.getElementById('settingsBtn');
      const closeBtn = document.getElementById('cancelSettings');
      const saveBtn = document.getElementById('saveSettings');
      const keyInput = document.getElementById('apiKeyInput');
      const modelInput = document.getElementById('modelInput');

      btn.addEventListener('click', () => {
        keyInput.value = apiKey;
        modelInput.value = modelName;
        modal.classList.add('active');
      });
      const closeModal = () => modal.classList.remove('active');
      closeBtn.addEventListener('click', closeModal);
      saveBtn.addEventListener('click', () => {
        apiKey = keyInput.value.trim();
        modelName = modelInput.value.trim() || modelName;
        localStorage.setItem('di_apiKey', apiKey);
        localStorage.setItem('di_modelName', modelName);
        alert('Conexão Neural Salva.');
        closeModal();
      });
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    }

    function setupTogglePanel() {
      const panel = document.getElementById('togglePanel');
      const btn = document.getElementById('toggleBtn');
      const closeBtn = document.getElementById('closePanelBtn');
      const saveBtn = document.getElementById('savePanelBtn');
      const userInput = document.getElementById('userNameInput');
      const infodoseInput = document.getElementById('infodoseNameInput');
      const assistantChk = document.getElementById('assistantActiveCheckbox');
      const trainingChk = document.getElementById('trainingActiveCheckbox');
      const fileInput = document.getElementById('trainingUpload');
      const importBtn = document.getElementById('importTrainingBtn');
      const exportBtn = document.getElementById('exportTrainingBtn');
      const trainingNameEl = document.getElementById('trainingFileName');

      btn.addEventListener('click', () => {
        userInput.value = userName;
        infodoseInput.value = infodoseName;
        assistantChk.checked = !!assistantEnabled;
        trainingChk.checked = !!trainingActive;
        panel.classList.add('active');
      });
      closeBtn.addEventListener('click', ()=> panel.classList.remove('active'));
      saveBtn.addEventListener('click', () => {
        userName = userInput.value.trim();
        infodoseName = infodoseInput.value.trim();
        assistantEnabled = !!assistantChk.checked;
        trainingActive = !!trainingChk.checked;
        localStorage.setItem('di_userName', userName);
        localStorage.setItem('di_infodoseName', infodoseName);
        localStorage.setItem('di_assistantEnabled', assistantEnabled ? '1' : '0');
        localStorage.setItem('di_trainingActive', trainingActive ? '1' : '0');
        updateTopInfo();
        updateToggleUI();
        panel.classList.remove('active');
      });

      fileInput.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        trainingFileName = f.name;
      });

      importBtn.addEventListener('click', ()=> {
        const f = fileInput.files[0];
        if (!f) { alert('Escolha um arquivo .txt para importar.'); return; }
        const r = new FileReader();
        r.onload = (ev) => {
          training = ev.target.result;
          trainingFileName = f.name || 'uploaded_training.txt';
          localStorage.setItem('di_trainingText', training);
          localStorage.setItem('di_trainingFileName', trainingFileName);
          const tf = document.getElementById('trainingFileName');
          if (tf) tf.innerText = trainingFileName;
          alert('Treinamento importado e salvo localmente.');
        };
        r.readAsText(f,'utf-8');
      });

      exportBtn.addEventListener('click', ()=> {
        if (!training) { alert('Nenhum treinamento presente para exportar.'); return; }
        const blob = new Blob([training], { type:'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = trainingFileName || 'training_export.txt'; a.click(); URL.revokeObjectURL(url);
      });
    }

    function setupCrystalModal() {
      const btn = document.getElementById('crystalBtn');
      const modal = document.getElementById('crystalModal');
      const close = document.getElementById('closeCrystal');
      const exportAll = document.getElementById('exportAllCrystal');
      const clearAll = document.getElementById('clearAllCrystal');

      btn.addEventListener('click', () => {
        refreshCrystalList();
        modal.classList.add('active');
      });
      close.addEventListener('click', ()=> modal.classList.remove('active'));
      exportAll.addEventListener('click', ()=> {
        const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
        if (!list.length) { alert('Nada para exportar.'); return; }
        const content = list.map(it => `--- ${it.title} · ${it.at} · ${it.infodose}\n\n${it.content}\n\n`).join('\n');
        const blob = new Blob([content], { type:'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `cristalizados_${Date.now()}.txt`; a.click(); URL.revokeObjectURL(url);
      });
      clearAll.addEventListener('click', ()=> {
        if (!confirm('Limpar todos os cristalizados?')) return;
        localStorage.removeItem(CRYSTAL_KEY);
        refreshCrystalList();
      });
      document.getElementById('crystalModal').addEventListener('click', (e)=> { if (e.target === document.getElementById('crystalModal')) document.getElementById('crystalModal').classList.remove('active'); });
    }

    /* ---------- Clipboard + other small UI ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
      speechSynthesis.onvoiceschanged = () => { window._vozes = speechSynthesis.getVoices(); };

      apiKey = localStorage.getItem('di_apiKey') || apiKey;
      modelName = localStorage.getItem('di_modelName') || modelName;
      userName = localStorage.getItem('di_userName') || userName;
      infodoseName = localStorage.getItem('di_infodoseName') || infodoseName;
      assistantEnabled = (localStorage.getItem('di_assistantEnabled') === '1') || assistantEnabled;
      trainingActive = (localStorage.getItem('di_trainingActive') === '0') ? false : trainingActive;

      await loadInitialTraining();
      updateTopInfo();
      updateToggleUI();
      setupSettings();
      setupTogglePanel();
      setupCrystalModal();

      // particles init (safe call)
      try {
        particlesJS('particles-js',{
          particles:{ number:{value:40},color:{value:['#0ff','#f0f']}, shape:{type:'circle'},opacity:{value:0.4},size:{value:2.4}, move:{enable:true,speed:1.5} }, retina_detect:true
        });
      } catch(e){}

      // eventos básicos
      const sendBtn = document.getElementById('sendBtn');
      const userInputEl = document.getElementById('userInput');
      if (sendBtn) sendBtn.addEventListener('click', sendMessage);
      if (userInputEl) userInputEl.addEventListener('keypress', e => { if (e.key==='Enter') sendMessage(); });
      const prevBtn = document.querySelector('[data-action="prev"]');
      const nextBtn = document.querySelector('[data-action="next"]');
      if (prevBtn) prevBtn.addEventListener('click', () => changePage(-1));
      if (nextBtn) nextBtn.addEventListener('click', () => changePage(1));

      const copyBtn = document.querySelector('.copy-button');
      if (copyBtn) copyBtn.addEventListener('click', () => {
        const pages = Array.from(document.querySelectorAll('.response-container .page'));
        const fullText = pages.map(p => p.innerText.trim()).join('\n\n');
        navigator.clipboard.writeText(fullText);
      });

      const pasteBtn = document.querySelector('.paste-button');
      if (pasteBtn) pasteBtn.addEventListener('click', async () => {
        try {
          const text = await navigator.clipboard.readText();
          const inp = document.getElementById('userInput');
          if (inp) inp.value = text;
        } catch (err) { console.error('Falha ao colar', err); }
      });

      // voice quick
      const voiceBtn = document.getElementById('voiceBtn');
      if (voiceBtn) voiceBtn.addEventListener('click', ()=>{
        try {
          const R = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
          R.lang='pt-BR'; R.start();
          R.onresult = e => {
            document.getElementById('userInput').value = e.results[0][0].transcript;
            sendMessage();
          };
        } catch(e){}
      });
    });

    /* === MANTRA ZEN MODE === */
    const mantraBtn = document.getElementById('mantra-toggle');
    const mantraText = document.getElementById('mantra-text');
    let mantraCollapsed = false;
    const TXT_EXPANDED = `Do seu jeito. <strong>Sempre</strong> único. <strong>Sempre</strong> seu.`;
    const TXT_COLLAPSED = `USE · TRANSFORME · DEVOLVA`;
    function swapMantraText(html) {
      mantraText.classList.add('fade-out');
      setTimeout(() => {
        mantraText.innerHTML = html;
        mantraText.classList.remove('fade-out');
        mantraText.classList.add('fade-in');
        setTimeout(() => mantraText.classList.remove('fade-in'), 300);
      }, 300);
    }
    mantraBtn.addEventListener('click', () => {
      mantraCollapsed = !mantraCollapsed;
      if (mantraCollapsed) {
        mantraBtn.classList.add('collapsed');
        document.body.classList.add('zen-mode');
        swapMantraText(TXT_COLLAPSED);
      } else {
        mantraBtn.classList.remove('collapsed');
        document.body.classList.remove('zen-mode');
        swapMantraText(TXT_EXPANDED);
      }
    });
  </script>

  <!-- Scripts: Fusion HUD (keeps functions needed by sync patch) -->
  <script>
    lucide.createIcons();

    // ELEMENT REFERENCES
    const els = {
      card: document.getElementById('mainCard'),
      header: document.getElementById('cardHeader'),
      avatarTgt: document.getElementById('avatarTarget'),
      input: document.getElementById('inputUser'),
      lblHello: document.getElementById('lblHello'),
      lblName: document.getElementById('lblName'),
      clock: document.getElementById('clockTime'),
      smallPreview: document.getElementById('smallPreview'),
      smallMiniAvatar: document.getElementById('smallMiniAvatar'),
      smallText: document.getElementById('smallText'),
      smallIdent: document.getElementById('smallIdent'),
      actCard: document.getElementById('activationCard'),
      actPre: document.getElementById('actPre'),
      actName: document.getElementById('actName'),
      actMiniAvatar: document.getElementById('actMiniAvatar'),
      actBadge: document.getElementById('actBadge'),
      securityStatus: document.getElementById('securityStatus'),
      // Keys UI
      keysModal: document.getElementById('keysModal'),
      keyList: document.getElementById('keyList'),
      keyName: document.getElementById('keyNameInput'),
      keyToken: document.getElementById('keyTokenInput'),
      keyWebhook: document.getElementById('keyWebhookInput'),
      addKeyBtn: document.getElementById('addKeyBtn'),
      closeKeysBtn: document.getElementById('closeKeysBtn'),
      testWebhookBtn: document.getElementById('testWebhookBtn'),
      exportKeysBtn: document.getElementById('exportKeysBtn'),
      importKeysBtn: document.getElementById('importKeysBtn'),
      importFileInput: document.getElementById('importFileInput'),
      lockVaultBtn: document.getElementById('lockVaultBtn'),
      vaultStatusText: document.getElementById('vaultStatusText'),
      // Vault UI
      vaultModal: document.getElementById('vaultModal'),
      vaultPass: document.getElementById('vaultPassInput'),
      vaultUnlock: document.getElementById('vaultUnlockBtn'),
      vaultCancel: document.getElementById('vaultCancelBtn')
    };

    // --- CRYPTO UTILS (AES-GCM) ---
    const CRYPTO = {
      algo: { name: 'AES-GCM', length: 256 },
      pbkdf2: { name: 'PBKDF2', hash: 'SHA-256', iterations: 100000 },
      salt: window.crypto.getRandomValues(new Uint8Array(16)),
      async getKey(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
        return window.crypto.subtle.deriveKey({ ...this.pbkdf2, salt: salt }, keyMaterial, this.algo, false, ["encrypt", "decrypt"]);
      },
      async encrypt(data, password) {
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const key = await this.getKey(password, salt);
        const encoded = new TextEncoder().encode(JSON.stringify(data));
        const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, encoded);
        const bundle = { s: Array.from(salt), iv: Array.from(iv), d: Array.from(new Uint8Array(encrypted)) };
        return JSON.stringify(bundle);
      },
      async decrypt(bundleStr, password) {
        try {
          const bundle = JSON.parse(bundleStr);
          const salt = new Uint8Array(bundle.s);
          const iv = new Uint8Array(bundle.iv);
          const data = new Uint8Array(bundle.d);
          const key = await this.getKey(password, salt);
          const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
          return JSON.parse(new TextDecoder().decode(decrypted));
        } catch(e) { throw new Error("Senha incorreta ou dados corrompidos"); }
      }
    };

    // --- STATE & STORAGE ---
    const STORAGE_KEY = 'fusion_os_data_v2';
    let STATE = {
      keys: [],
      user: 'Convidado',
      isEncrypted: false,
      encryptedData: null
    };
    let SESSION_PASSWORD = null;

    function saveData() {
      const payload = { keys: STATE.keys, user: STATE.user };
      if (SESSION_PASSWORD) {
        CRYPTO.encrypt(payload, SESSION_PASSWORD).then(enc => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ isEncrypted: true, data: enc }));
          STATE.isEncrypted = true;
          STATE.encryptedData = enc;
          updateSecurityUI();
        });
      } else {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ isEncrypted: false, data: payload }));
      }
    }

    async function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed.isEncrypted) {
        STATE.isEncrypted = true;
        STATE.encryptedData = parsed.data;
        updateSecurityUI();
      } else {
        STATE.keys = parsed.data.keys || [];
        STATE.user = parsed.data.user || 'Convidado';
        updateInterface(STATE.user);
        renderKeysList();
      }
    }

    // --- UI UPDATES ---
    const hashStr = s => { let h=0xdeadbeef; for(let i=0;i<s.length;i++){h=Math.imul(h^s.charCodeAt(i),2654435761);} return (h^h>>>16)>>>0; };
    const createSvg = (id,sz) => `<svg viewBox="0 0 100 100" width="${sz}" height="${sz}"><defs><linearGradient id="g${id}"><stop offset="0%" stop-color="#00f2ff"/><stop offset="100%" stop-color="#bd00ff"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="#080b12" stroke="rgba(255,255,255,0.1)"/><circle cx="50" cy="50" r="20" fill="url(#g${id})" opacity="0.9"/></svg>`;
    const createMiniSvg = (name,sz=30) => {
      const s = hashStr(name||'D'); const h1=s%360; const h2=(s*37)%360;
      const grad = `<linearGradient id="gm${s}" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="hsl(${h1},90%,50%)"/><stop offset="1" stop-color="hsl(${h2},90%,50%)"/></linearGradient>`;
      return `<svg width="${sz}" height="${sz}" viewBox="0 0 32 32"><defs>${grad}</defs><rect width="32" height="32" rx="8" fill="#0a1016"/><circle cx="16" cy="16" r="6" fill="url(#gm${s})"/></svg>`;
    };

    function updateInterface(name){
      const safe = name || 'Convidado';
      els.lblName.innerText = safe;
      els.input.value = safe;
      const activeKey = STATE.keys.find(k=>k.active);
      els.smallIdent.innerText = activeKey ? activeKey.name : '--';
      els.actBadge.innerText = activeKey ? `key:${activeKey.name}` : 'v:--';
      els.smallMiniAvatar.innerHTML = createMiniSvg(safe);
      els.actMiniAvatar.innerHTML = createMiniSvg(safe,36);
      els.actName.innerText = safe;
      els.avatarTgt.innerHTML = createSvg('Main',64);
      const phrases = ["Foco estável.","Ritmo criativo.","Percepção sutil."];
      els.smallText.innerText = activeKey ? `${activeKey.name} [ATIVO]` : (safe==='Convidado'?'Aguardando...':`${safe} · ${phrases[safe.length%phrases.length]}`);
      const line = `+${'-'.repeat(safe.length+4)}+`;
      els.actPre.innerText = `${line}\n| ${safe.toUpperCase()} |\n${line}\nID: ${hashStr(safe).toString(16)}`;
      // sync top-info if chat is present
      try { if (typeof userName === 'undefined') {} else { userName = safe; localStorage.setItem('di_userName', safe); updateTopInfo(); } } catch(e){}
    }

    function updateSecurityUI() {
      if (SESSION_PASSWORD) {
        els.securityStatus.innerText = "COFRE DESTRANCADO";
        els.securityStatus.style.color = "var(--neon-success)";
        els.vaultStatusText.innerText = "Cofre Protegido (Destrancado)";
        els.lockVaultBtn.innerText = "TRANCAR";
      } else if (STATE.isEncrypted) {
        els.securityStatus.innerText = "CRIPTOGRAFADO";
        els.securityStatus.style.color = "var(--neon-gold)";
        els.vaultStatusText.innerText = "Cofre Trancado";
        els.lockVaultBtn.innerText = "REDEFINIR";
      } else {
        els.securityStatus.innerText = "SEM PROTEÇÃO";
        els.securityStatus.style.color = "rgba(255,255,255,0.5)";
        els.vaultStatusText.innerText = "Cofre Aberto (Sem senha)";
        els.lockVaultBtn.innerText = "CRIAR SENHA";
      }
    }

    // --- KEYS MANAGER LOGIC ---
    function renderKeysList(){
      els.keyList.innerHTML = '';
      if(STATE.keys.length===0){ els.keyList.innerHTML = '<div style="color:rgba(255,255,255,0.3);text-align:center;padding:20px">Nenhuma chave armazenada.</div>'; return; }
      STATE.keys.forEach(k=>{
        const div = document.createElement('div');
        div.className = `key-item ${k.active?'active-item':''}`;
        const typeInfo = k.webhook ? '<span style="color:var(--neon-purple)">WEBHOOK</span>' : 'API KEY';
        div.innerHTML = `
          <div class="meta">
            <div style="font-weight:700;font-size:0.9rem">${escapeHtml(k.name)}</div>
            <div style="font-size:0.75rem;color:rgba(255,255,255,0.5)">${typeInfo}</div>
          </div>
          <div class="actions">
            ${!k.active ? `<button class="small-btn" onclick="setActiveKey('${k.id}')">ATIVAR</button>` : `<span style="font-size:0.7rem;font-weight:700;color:var(--neon-cyan);margin-right:10px">ATIVA</span>`}
            <button class="small-btn danger" onclick="removeKey('${k.id}')"><i data-lucide="trash-2" style="width:14px"></i></button>
          </div>
        `;
        els.keyList.appendChild(div);
      });
      lucide.createIcons();
    }

    function addKey() {
      const name = els.keyName.value.trim();
      const token = els.keyToken.value.trim();
      const webhook = els.keyWebhook.value.trim();
      if(!name){ showToaster('Nome obrigatório','error'); return; }
      const newKey = { id: Date.now().toString(36), name, token, webhook, active: STATE.keys.length===0 };
      STATE.keys.push(newKey);
      saveData();
      renderKeysList();
      updateInterface(STATE.user);
      els.keyName.value=''; els.keyToken.value=''; els.keyWebhook.value='';
      showToaster('Chave adicionada!', 'success');
    }

    window.removeKey = (id) => {
      if(confirm('Remover chave permanentemente?')){
        STATE.keys = STATE.keys.filter(k=>k.id!==id);
        saveData(); renderKeysList(); updateInterface(STATE.user);
      }
    };

    window.setActiveKey = (id) => {
      STATE.keys.forEach(k=> k.active = (k.id===id));
      saveData(); renderKeysList(); updateInterface(STATE.user);
      showToaster('Chave ativa atualizada.', 'success');
      // sync: if active key has token, write to di_apiKey for chat module
      try {
        const active = STATE.keys.find(k=>k.active);
        if (active?.token) {
          localStorage.setItem('di_apiKey', active.token);
          if (active.model) localStorage.setItem('di_modelName', active.model);
        }
      } catch(e){}
    };

    // --- WEBHOOK TEST ---
    els.testWebhookBtn.addEventListener('click', async () => {
       const url = els.keyWebhook.value.trim();
       if(!url) return showToaster('Insira uma URL', 'error');
       els.testWebhookBtn.innerHTML = '...';
       try {
         const controller = new AbortController();
         setTimeout(()=>controller.abort(), 4000);
         await fetch(url, { method: 'POST', body: JSON.stringify({ping:true}), mode: 'no-cors', signal: controller.signal });
         showToaster('Envio realizado (Ping)', 'success');
       } catch(e) {
         showToaster('Falha na conexão', 'error');
       } finally {
         els.testWebhookBtn.innerText = 'PING';
       }
    });

    // --- VAULT FLOW ---
    function openManager() {
      if (STATE.isEncrypted && !SESSION_PASSWORD) {
        els.vaultModal.style.display = 'flex';
        els.vaultModal.setAttribute('aria-hidden', 'false');
        els.vaultPass.focus();
      } else {
        els.keysModal.style.display = 'flex';
        els.keysModal.setAttribute('aria-hidden', 'false');
      }
    }

    els.vaultUnlock.addEventListener('click', async () => {
      const pass = els.vaultPass.value;
      try {
        const decrypted = await CRYPTO.decrypt(STATE.encryptedData, pass);
        SESSION_PASSWORD = pass;
        STATE.keys = decrypted.keys;
        STATE.user = decrypted.user;
        els.vaultModal.style.display = 'none';
        els.keysModal.style.display = 'flex';
        els.vaultPass.value = '';
        renderKeysList();
        updateSecurityUI();
        showToaster('Cofre destrancado.', 'success');
      } catch(e) {
        showToaster('Senha incorreta.', 'error');
        els.vaultPass.classList.add('vibe-gold');
        setTimeout(()=>els.vaultPass.classList.remove('vibe-gold'), 500);
      }
    });

    els.lockVaultBtn.addEventListener('click', () => {
       if (!SESSION_PASSWORD && !STATE.isEncrypted) {
         const newPass = prompt("Defina uma senha para o Cofre:");
         if(newPass) {
           SESSION_PASSWORD = newPass;
           saveData();
           showToaster("Cofre criado e trancado.", 'success');
         }
       } else {
         SESSION_PASSWORD = null;
         els.keysModal.style.display = 'none';
         showToaster("Cofre trancado.", 'success');
       }
       updateSecurityUI();
    });

    els.vaultCancel.addEventListener('click', ()=> els.vaultModal.style.display='none');
    els.closeKeysBtn.addEventListener('click', ()=> els.keysModal.style.display='none');
    els.addKeyBtn.addEventListener('click', addKey);

    // Import/Export
    els.exportKeysBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(STATE.keys, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='fusion_keys.json'; a.click();
    });
    els.importKeysBtn.addEventListener('click', ()=> els.importFileInput.click());
    els.importFileInput.addEventListener('change', (e)=>{
       const f = e.target.files[0];
       if(f) {
         const r = new FileReader();
         r.onload = (ev) => {
           try { STATE.keys = JSON.parse(ev.target.result); saveData(); renderKeysList(); showToaster('Chaves importadas!','success'); }
           catch(e){ showToaster('Arquivo inválido','error'); }
         };
         r.readAsText(f);
       }
    });

    // --- GESTURES / INTERACTION ---
    let state = { isOrb:false, isHud:false, isDragging:false, startX:0, startY:0, timer:null };
    els.card.addEventListener('pointerdown', handleStart);
    document.addEventListener('pointermove', handleMove);
    document.addEventListener('pointerup', handleEnd);

    // Click on Avatar in Card Mode -> Open Manager (with lazy-load ZebNeb)
    els.avatarTgt.addEventListener('click', async (e)=>{
       // lazy-load ZebNeb-like heavy script on first use
       if (!window.__zebnebLoaded) {
         try {
           // Placeholder for external script if needed
           window.__zebnebLoaded = true; console.log('ZebNeb placeholder loaded');
         } catch(err){ console.warn('zebneb load error', err); }
       }
       if(!state.isOrb && !state.isHud) openManager();
    });

    function handleStart(e) {
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('.keys-card')) return;
      if(!state.isOrb && !state.isHud && !els.header.contains(e.target)) return;
      state.startX = e.clientX; state.startY = e.clientY; state.isDragging = false;
      state.timer = setTimeout(() => {
        if(state.isOrb) openManager();
        else if (!state.isHud) transmuteToOrb(e.clientX, e.clientY);
      }, 600);
      if(state.isOrb) {
         els.card.setPointerCapture(e.pointerId);
         const rect = els.card.getBoundingClientRect();
         state.offsetX = e.clientX - rect.left;
         state.offsetY = e.clientY - rect.top;
      }
    }

    function handleMove(e) {
      if(!state.timer && !state.isOrb) return;
      const dist = Math.hypot(e.clientX - state.startX, e.clientY - state.startY);
      if(dist > 10) {
        if(state.timer) { clearTimeout(state.timer); state.timer = null; }
        if(state.isOrb) {
          state.isDragging = true;
          els.card.style.left = (e.clientX - state.offsetX) + 'px';
          els.card.style.top = (e.clientY - state.offsetY) + 'px';
          els.card.style.transform = 'none';
        }
      }
    }

    function handleEnd(e) {
      if(state.timer) { clearTimeout(state.timer); state.timer = null; }
      if(state.isDragging && state.isOrb) {
        state.isDragging = false; snapOrb(e.clientX, e.clientY); return;
      }
      const dist = Math.hypot(e.clientX - state.startX, e.clientY - state.startY);
      if(dist < 10) {
        if(state.isOrb || state.isHud) revertToCard();
        else toggleCardState();
      }
    }

    function transmuteToOrb(x,y) {
      if(navigator.vibrate) navigator.vibrate(50);
      els.card.classList.add('orb','closed'); els.card.classList.remove('content-visible');
      els.card.style.left=(x-34)+'px'; els.card.style.top=(y-34)+'px';
      state.isOrb=true; state.isHud=false;
    }

    function snapOrb(x,y) {
      if(y < 80) {
        state.isHud=true; state.isOrb=false; els.card.classList.add('hud'); els.card.classList.remove('orb');
        els.card.style.left=''; els.card.style.top=''; els.card.style.transform='';
      } else {
        const tx = x < window.innerWidth/2 ? 15 : window.innerWidth-83;
        els.card.style.transition='left 0.4s ease, top 0.4s ease'; els.card.style.left=tx+'px';
        setTimeout(()=>els.card.style.transition='',400);
      }
    }

    function revertToCard() {
      state.isOrb=false; state.isHud=false;
      els.card.style.transition='all 0.5s var(--ease-smooth)'; els.card.style.left=''; els.card.style.top=''; els.card.style.width=''; els.card.style.height=''; els.card.style.transform='';
      els.card.classList.remove('orb','hud','closed');
      setTimeout(()=>els.card.classList.add('content-visible'),300);
    }

    function toggleCardState() {
      if(els.card.classList.contains('animating')) return;
      const isClosed = els.card.classList.contains('closed');
      els.card.classList.add('animating');
      if(isClosed) {
        els.card.classList.remove('closed');
        els.card.animate([{transform:'scale(0.95)',opacity:0.8},{transform:'scale(1)',opacity:1}],{duration:400,easing:'cubic-bezier(0.34,1.3,0.64,1)'})
        .onfinish = ()=>{ els.card.classList.remove('animating'); els.card.classList.add('content-visible'); }
      } else {
        els.card.classList.remove('content-visible');
        els.card.animate([{transform:'translateY(0)',opacity:1},{transform:'translateY(10px)',opacity:1}],{duration:200,easing:'ease-in'})
        .onfinish = ()=>{ els.card.classList.add('closed'); els.card.classList.remove('animating'); }
      }
    }

    // --- MISC UTILS ---
    function escapeHtml(s){ return s ? s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : ''; }
    function showToaster(txt,type='default'){ const t=document.createElement('div'); t.className=`toaster ${type}`; t.innerText=txt; document.getElementById('toasterWrap').appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},2500); }
    function toggleActivation(){ const h=els.actCard.classList.contains('activation-hidden'); els.actCard.classList.toggle('activation-hidden',!h); els.actCard.classList.toggle('activation-open',h); }

    // Copy/Download
    document.getElementById('copyActBtn').addEventListener('click', ()=>{
       const active = STATE.keys.find(k=>k.active);
       const append = active ? `\n\n[Active Key: ${active.name}]` : '';
       navigator.clipboard.writeText(els.actPre.innerText + append).then(()=>showToaster('Copiado!'));
    });
    document.getElementById('downloadActBtn').addEventListener('click', async()=>{
       const canvas = await html2canvas(els.actPre, {scale:2, backgroundColor:null});
       canvas.toBlob(b=>{ const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='activation.png'; a.click(); });
    });

    // Init
    els.input.addEventListener('input', (e)=>{ STATE.user=e.target.value; updateInterface(e.target.value); saveData(); });
    setTimeout(()=>{ els.card.classList.add('active'); els.avatarTgt.classList.add('shown'); loadData(); }, 100);
    setInterval(()=>{ els.clock.innerText = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); },1000);

    /* ==== Patch sync userName (força persistência) ==== */
    (function(){
      const safeUpdateUserName = (name) => {
        try {
          name = (name||'').toString();
          if (typeof STATE !== 'undefined') STATE.user = name || STATE.user;
          if (typeof userName !== 'undefined') userName = name || userName;
          localStorage.setItem('di_userName', name || '');
          try { if (typeof updateTopInfo === 'function') updateTopInfo(); } catch(e){}
        } catch(e) { console.warn('safeUpdateUserName', e); }
      };

      const inputCard = document.getElementById('inputUser');
      if (inputCard) {
        inputCard.addEventListener('change', (e) => safeUpdateUserName(e.target.value));
        inputCard.addEventListener('blur', (e) => safeUpdateUserName(e.target.value));
        if (inputCard.value && inputCard.value.trim()) safeUpdateUserName(inputCard.value.trim());
      }

      const origUpdateInterface = window.updateInterface;
      if (typeof origUpdateInterface === 'function') {
        window.updateInterface = function(name){
          try { origUpdateInterface(name); } catch(e){ console.warn(e); }
          try { safeUpdateUserName(name); } catch(e){}
        };
      }
    })();
  </script>

  <!-- BEGIN: Dual Infodose — OpenRouter / LocalStorage Sync Patch (single copy) -->
  <script>
  (function(){
    function chatSyncOnStorage() {
      try {
        if (typeof apiKey !== 'undefined') {
          const newKey = localStorage.getItem('di_apiKey') || '';
          if (newKey && newKey !== apiKey) {
            apiKey = newKey;
            const keyEl = document.getElementById('apiKeyInput');
            if (keyEl) keyEl.value = apiKey;
          }
        }

        if (typeof modelName !== 'undefined') {
          const newModel = localStorage.getItem('di_modelName') || '';
          if (newModel && newModel !== modelName) {
            modelName = newModel;
            const mEl = document.getElementById('modelInput');
            if (mEl) mEl.value = modelName;
          }
        }

        if (typeof training !== 'undefined') {
          const t = localStorage.getItem('di_trainingText');
          if (t && training !== t) {
            training = t;
            const fname = localStorage.getItem('di_trainingFileName') || '';
            const fEl = document.getElementById('trainingFileName');
            if (fEl && fname) fEl.innerText = fname;
          }
        }

        if (typeof userName !== 'undefined')
          userName = localStorage.getItem('di_userName') || '';

        if (typeof infodoseName !== 'undefined')
          infodoseName = localStorage.getItem('di_infodoseName') || '';

        const dispU = document.getElementById('displayUser');
        const dispI = document.getElementById('displayInfodose');

        if (dispU) dispU.innerText = 'User: ' + (userName || '—');
        if (dispI) dispI.innerText = 'Infodose: ' + (infodoseName || '—');

      } catch (e) {
        console.warn('[Dual Sync] chatSync error', e);
      }
    }

    function cardImportDiApiKey() {
      try {
        if (typeof STATE === 'undefined' || !Array.isArray(STATE.keys)) return;
        const sk = localStorage.getItem('di_apiKey');
        const model = localStorage.getItem('di_modelName') || '';
        if (!sk) return;
        let key = STATE.keys.find(k => k.token === sk);
        if (!key) {
          STATE.keys.forEach(k => k.active = false);
          STATE.keys.unshift({
            id: 'import-' + Date.now(),
            name: 'Imported-SK',
            token: sk,
            model: model,
            webhook: '',
            active: true
          });
        } else {
          STATE.keys.forEach(k => k.active = (k.token === sk));
        }
        if (typeof saveData === 'function') saveData();
        if (typeof renderKeysList === 'function') renderKeysList();
        if (typeof updateInterface === 'function') updateInterface(STATE.user);
      } catch (e) {
        console.warn('[Dual Sync] cardImport error', e);
      }
    }

    try {
      if (typeof window.setActiveKey === 'function') {
        const original = window.setActiveKey.bind(window);
        window.setActiveKey = function(id) {
          original(id);
          try {
            const active = STATE?.keys?.find(k => k.active);
            if (active?.token) {
              localStorage.setItem('di_apiKey', active.token);
              if (active.model) localStorage.setItem('di_modelName', active.model);
            }
          } catch(e){}
        };
      }
    } catch(e){}

    window.addEventListener('storage', (e) => {
      const keys = [
        'di_apiKey',
        'di_modelName',
        'di_trainingText',
        'di_trainingFileName',
        'di_userName',
        'di_infodoseName',
        'di_assistantEnabled',
        'di_trainingActive'
      ];
      if (keys.includes(e.key)) {
        chatSyncOnStorage();
        cardImportDiApiKey();
      }
    });

    setTimeout(() => {
      chatSyncOnStorage();
      cardImportDiApiKey();
    }, 80);

  })();
  </script>
  <!-- END: Dual Infodose Sync Patch -->







  <div class="void-ambient"></div>
  <iframe id="navFrame" src="./index.html"></iframe>

  <div class="top-bar">
    <div class="brand-text"></div>
    <div class="sep"></div>
    <button id="themeToggle" class="theme-btn" title="Toggle Theme"><i class="fa-solid fa-circle-half-stroke"></i></button>
  </div>

  <div class="sidebar right">
    <button class="icon-btn nav-btn" data-url="https://kodux78k.github.io/oiDual-DeX/" title="Void">Φ</button>
    <button class="icon-btn nav-btn" data-url="https://kodux78k.github.io/oiDual-Vivivi-1/" title="Vivivi">꩜</button>
    <button class="icon-btn nav-btn" data-url="https://kodux78k.github.io/DualInfodose-VirgemHuB/index.html" title="Nosolar">☼</button>
  </div>

  <div class="sidebar left">
    <button id="uploadBtn" class="icon-btn" title="Import File"><i class="fa-solid fa-upload"></i></button>
    <input type="file" id="uploadInput" hidden="" accept=".html,.js,.json">
    <button id="remoteBtn" class="icon-btn" title="Fetch Remote"><i class="fa-solid fa-globe"></i></button>
  </div>

  <div class="monolith-wrapper">
    <div class="monolith">
      
      <div class="mono-header">
        <div class="mono-brand">
          <div class="brand-icon"><i data-lucide="layers" style="width:16px;height:16px;"></i></div>
          <div class="brand-title">DUAL <span style="opacity:0.3; margin:0 4px;">//</span> MONOLITH</div>
        </div>
        <div id="sysStatus" class="status-badge">STANDBY</div>
      </div>

      <div class="mono-body">
        <div id="viewVault" class="vault-view">
          <div class="actions-grid">
            <button id="createBtn" class="action-card btn-create">
              <i data-lucide="plus-square" style="width:16px;"></i> <span>NOVO</span>
            </button>
            <div id="dropZone" class="action-card dashed">
              <i data-lucide="upload" style="width:16px;"></i> <span style="font-family: var(--font-code)">UPLOAD</span>
            </div>
            <button id="backupBtn" class="action-card">
              <i data-lucide="download" style="width:16px;"></i> <span>BACKUP</span>
            </button>
            <button id="safeBtn" class="action-card">
              <i data-lucide="shield" style="width:16px; color:var(--alert-red)"></i> <span id="safeLabel">SAFE</span>
            </button>
          </div>

          <div class="list-header">
            <span class="list-label">VAULT STORAGE</span>
            <span class="list-label" id="vaultCount">0 ITEMS</span>
          </div>
          <div id="stackList" class="flex flex-col gap-3" style="padding-bottom: 3rem;"></div>
        </div>

        <div id="viewEditor" class="editor-view state-translated-x">
          <div class="editor-header">
            <div class="editor-title">:: MODULE CREATOR</div>
            <button id="cancelEditor" class="btn-cancel">CANCELAR</button>
          </div>
          <input id="modTitle" type="text" placeholder="NOME DO MÓDULO" class="input-title">
          <div class="code-area">
            <textarea id="modContent" placeholder=""></textarea>
          </div>
          <div class="flex gap-3">
            <button id="saveEditor" class="btn-save">SALVAR NO VAULT</button>
          </div>
        </div>
      </div>

      <div class="mono-footer">
        <div id="pulseBar"></div>
      </div>

      <div id="runtimeLayer" class="runtime-layer">
        <div class="runtime-bar">
          <div class="runtime-indicator">
            <div class="dot"></div> <span>RUNTIME // ACTIVE</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="exportBtn" class="btn-cancel" style="font-size:10px;">EXPORT TO NAV</button>
            <button id="closeRuntime" class="icon-btn" style="width:24px; height:24px; border:none; background:transparent;"><i data-lucide="x" style="width:16px;"></i></button>
          </div>
        </div>
        <div class="runtime-frame-wrap">
<iframe id="appFrame" style="border:0;width:100%;height:100%;display:block;" sandbox="allow-scripts allow-forms allow-modals allow-same-origin allow-pointer-lock">
</iframe>
          <div class="scanline"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="orb-container">
    <button id="orbBtn" class="orb-btn" aria-label="Toggle System">
      <div class="orb-core"></div>
      <div class="orb-ring"></div>
      <div class="orb-ring inner"></div>
    </button>
  </div>

  <div id="toast" class="toast-hidden">
    <span id="toastMsg">System Ready</span>
  </div>

  <script>
  const App = {
    config: {
      vaultKey: 'dual_vault_data',
      themeKey: 'dual_theme_mode',
      navKey: 'dual_nav_state',
      sysKey: 'dual_system_active'
    },
    state: {
      active: false,
      safeMode: true,
      stacks: [],
      editingId: null // novo: id do módulo que está sendo editado (null = criar novo)
    },

    init() {
      this.cacheDOM();
      this.loadData();
      this.bindEvents();
      if(window.lucide) lucide.createIcons();

      const theme = localStorage.getItem(this.config.themeKey);
      if(theme) document.documentElement.setAttribute('data-theme', theme);

      const wasActive = localStorage.getItem(this.config.sysKey) === 'true';
      if(wasActive) this.toggleSystem(true);
      else setTimeout(() => this.dom.orbBtn.classList.add('ready'), 500);
    },

    cacheDOM() {
      this.dom = {
        body: document.body,
        navFrame: document.getElementById('navFrame'),
        orbBtn: document.getElementById('orbBtn'),
        sysStatus: document.getElementById('sysStatus'),
        stackList: document.getElementById('stackList'),
        viewVault: document.getElementById('viewVault'),
        viewEditor: document.getElementById('viewEditor'),
        runtimeLayer: document.getElementById('runtimeLayer'),
        appFrame: document.getElementById('appFrame'),
        modTitle: document.getElementById('modTitle'),
        modContent: document.getElementById('modContent'),
        toast: document.getElementById('toast'),
        pulseBar: document.getElementById('pulseBar'),
        safeLabel: document.getElementById('safeLabel'),
        uploadInput: document.getElementById('uploadInput'),
        remoteBtn: document.getElementById('remoteBtn')
      };
    },

    bindEvents() {
      this.dom.orbBtn.addEventListener('click', () => this.toggleSystem());
      document.querySelectorAll('[data-url]').forEach(btn => {
        btn.addEventListener('click', () => {
          this.dom.navFrame.src = btn.dataset.url;
          this.showToast(`NAV: ${btn.title}`);
        });
      });

      document.getElementById('createBtn').addEventListener('click', () => this.toggleEditor(true));
      document.getElementById('cancelEditor').addEventListener('click', () => this.cancelEditing());
      document.getElementById('saveEditor').addEventListener('click', () => this.saveModule());

      document.getElementById('dropZone').addEventListener('click', () => this.dom.uploadInput.click());
      this.dom.uploadInput.addEventListener('change', (e) => this.handleUpload(e));
      document.getElementById('uploadBtn').addEventListener('click', () => this.dom.uploadInput.click());
      document.getElementById('backupBtn').addEventListener('click', () => this.exportVault());

      document.getElementById('safeBtn').addEventListener('click', () => this.toggleSafe());

      document.getElementById('themeToggle').addEventListener('click', () => {
         const current = document.documentElement.getAttribute('data-theme');
         const next = current === 'light' ? 'dark' : 'light';
         document.documentElement.setAttribute('data-theme', next);
         localStorage.setItem(this.config.themeKey, next);
         this.showToast(`THEME: ${next.toUpperCase()}`);
      });

      document.getElementById('closeRuntime').addEventListener('click', () => this.closeRuntime());
      document.getElementById('exportBtn').addEventListener('click', () => {
        if(this.dom.appFrame.srcdoc) {
          const blob = new Blob([this.dom.appFrame.srcdoc], {type:'text/html'});
          this.dom.navFrame.src = URL.createObjectURL(blob);
          this.showToast("EXPORTED TO NAV");
          this.closeRuntime();
        }
      });

      // Novo: botão globo aceita URLs
      this.dom.remoteBtn.addEventListener('click', () => this.handleRemoteUrl());
    },

    loadData() {
      try {
        const raw = localStorage.getItem(this.config.vaultKey);
        if(raw) this.state.stacks = JSON.parse(raw);
      } catch(e) { this.state.stacks = []; }
      this.renderVault();

      const last = localStorage.getItem(this.config.navKey);
      if(last && last !== 'about:blank') this.dom.navFrame.src = last;

      this.dom.navFrame.onload = () => {
        try { localStorage.setItem(this.config.navKey, this.dom.navFrame.contentWindow.location.href); } catch(e){}
      };
    },

    toggleSystem(force) {
      this.state.active = force !== undefined ? force : !this.state.active;
      localStorage.setItem(this.config.sysKey, this.state.active);
      if(this.state.active) {
        this.dom.body.classList.add('system-active');
        this.dom.sysStatus.innerText = "ONLINE";
        this.dom.sysStatus.style.color = "var(--neon-cyan)";
        this.dom.sysStatus.style.borderColor = "var(--neon-cyan)";
      } else {
        this.dom.body.classList.remove('system-active');
        this.dom.sysStatus.innerText = "STANDBY";
        this.dom.sysStatus.style.color = "var(--text-muted)";
        this.dom.sysStatus.style.borderColor = "var(--glass-border)";
      }
    },

    toggleEditor(show, moduleObj = null) {
      if(show) {
        this.dom.viewEditor.classList.remove('state-translated-x');
        if(moduleObj) {
          // abrir em modo edição
          this.state.editingId = moduleObj.id;
          this.dom.modTitle.value = moduleObj.title || '';
          this.dom.modContent.value = moduleObj.content || '';
        } else {
          this.state.editingId = null;
          this.dom.modTitle.value = '';
          this.dom.modContent.value = '';
        }
        this.dom.modTitle.focus();
      } else {
        this.dom.viewEditor.classList.add('state-translated-x');
      }
    },

    cancelEditing() {
      this.state.editingId = null;
      this.toggleEditor(false);
    },

    toggleSafe() {
      this.state.safeMode = !this.state.safeMode;
      this.dom.safeLabel.innerText = this.state.safeMode ? "SAFE" : "RAW";
      this.dom.safeLabel.style.color = this.state.safeMode ? "inherit" : "var(--alert-red)";
      this.showToast(this.state.safeMode ? "PROTOCOL: SAFE" : "PROTOCOL: RAW (UNSAFE)");
    },

    exportVault() {
      const data = JSON.stringify(this.state.stacks, null, 2);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dual-vault-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      this.showToast("VAULT EXPORTED");
    },

    saveModule() {
      const title = this.dom.modTitle.value.trim();
      const content = this.dom.modContent.value;
      if(!title) return this.showToast("ERROR: TITLE REQUIRED");

      if(this.state.editingId) {
        // Atualiza módulo existente
        const idx = this.state.stacks.findIndex(s => s.id === this.state.editingId);
        if(idx === -1) return this.showToast("ERROR: MODULE NOT FOUND");
        this.state.stacks[idx].title = title;
        this.state.stacks[idx].content = content;
        this.state.stacks[idx].date = new Date().toLocaleDateString();
        localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
        this.showToast("MODULE UPDATED");
      } else {
        // Cria novo módulo
        const mod = {
          id: Date.now(),
          title,
          content: content || '<h1>Empty Module</h1>',
          date: new Date().toLocaleDateString()
        };
        this.state.stacks.unshift(mod);
        localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
        this.showToast("MODULE CRYSTALLIZED");
      }

      this.state.editingId = null;
      this.renderVault();
      this.toggleEditor(false);
    },

    handleUpload(e) {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
          try {
              const json = JSON.parse(ev.target.result);
              if(Array.isArray(json) && json[0]?.id) {
                  if(confirm("RESTORE BACKUP? This will merge with current vault.")) {
                      this.state.stacks = [...json, ...this.state.stacks];
                      this.state.stacks = this.state.stacks.filter((v,i,a)=>a.findIndex(v2=>(v2.id===v.id))===i);
                      localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
                      this.renderVault();
                      this.showToast("BACKUP RESTORED");
                      return;
                  }
              }
          } catch(e) { /* Not a JSON array, treat as single file */ }

        this.state.stacks.unshift({
          id: Date.now(),
          title: file.name,
          content: ev.target.result,
          date: new Date().toLocaleDateString()
        });
        localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
        this.renderVault();
        this.showToast("FILE UPLOADED");
      };
      reader.readAsText(file);
      // reset input so same file can be re-uploaded if needed
      e.target.value = '';
    },

    deleteModule(id) {
      if(!confirm("DELETE MODULE?")) return;
      this.state.stacks = this.state.stacks.filter(s => s.id !== id);
      localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
      this.renderVault();
    },

    // Novo: download individual
    downloadModule(id) {
      const mod = this.state.stacks.find(s => s.id === id);
      if(!mod) return this.showToast("ERROR: NOT FOUND");
      const blob = new Blob([mod.content], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // sanitize filename
      const safeName = (mod.title || 'module').replace(/[^\w\d\-_\.]/g,'_');
      a.download = `${safeName}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      this.showToast("DOWNLOAD STARTED");
    },

    renderVault() {
      this.dom.stackList.innerHTML = '';
      document.getElementById('vaultCount').innerText = `${this.state.stacks.length} ITEMS`;

      if(this.state.stacks.length === 0) {
        this.dom.stackList.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted); font-family:var(--font-code); font-size:12px;">VAULT EMPTY</div>`;
        return;
      }

      this.state.stacks.forEach(stack => {
        const el = document.createElement('div');
        el.className = 'stack-item';
        el.innerHTML = `
          <div class="stack-info">
            <div class="stack-icon"><i data-lucide="box" style="width:16px;"></i></div>
            <div class="stack-text">
              <h4>${this.escapeHtml(stack.title)}</h4>
              <span>${stack.date}</span>
            </div>
          </div>
          <div class="stack-actions">
            <button class="mini-btn btn-run" title="Run"><i data-lucide="play" style="width:12px;"></i></button>
            <button class="mini-btn btn-edit" title="Edit"><i data-lucide="edit-2" style="width:12px;"></i></button>
            <button class="mini-btn btn-dl" title="Download"><i data-lucide="download" style="width:12px;"></i></button>
            <button class="mini-btn btn-del" title="Delete"><i data-lucide="trash-2" style="width:12px;"></i></button>
          </div>
        `;

        // Bind actions
        el.querySelector('.btn-run').onclick = (e) => { e.stopPropagation(); this.runModule(stack.id); };
        el.querySelector('.btn-edit').onclick = (e) => { e.stopPropagation(); this.editModule(stack.id); };
        el.querySelector('.btn-dl').onclick = (e) => { e.stopPropagation(); this.downloadModule(stack.id); };
        el.querySelector('.btn-del').onclick = (e) => { e.stopPropagation(); this.deleteModule(stack.id); };
        el.onclick = () => this.runModule(stack.id);

        this.dom.stackList.appendChild(el);
      });

      if(window.lucide) lucide.createIcons();
    },

    escapeHtml(text) {
      if(!text) return '';
      return text.replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    },

    runModule(id) {
      const mod = this.state.stacks.find(s => s.id === id);
      if(!mod) return;

      let code = mod.content;
      if(this.state.safeMode) {
        try {
           if(!code.includes('<html') && !code.includes('<!doctype')) {
             code = `<style>body{color:#fff;background:transparent;font-family:sans-serif}</style>${code}`;
           }
        } catch(e){}
      }

      this.dom.appFrame.srcdoc = code;
      this.dom.runtimeLayer.classList.add('state-visible-y');
      this.dom.sysStatus.innerText = "RUNNING";
      this.dom.sysStatus.style.opacity = '0.7';
    },

    closeRuntime() {
      this.dom.runtimeLayer.classList.remove('state-visible-y');
      this.dom.sysStatus.style.opacity = '1';
      this.dom.sysStatus.innerText = "ONLINE";
      setTimeout(() => this.dom.appFrame.srcdoc = '', 400);
    },

    showToast(msg) {
      this.dom.toast.innerText = msg;
      this.dom.toast.classList.remove('toast-hidden');
      clearTimeout(this.toastTimer);
      this.toastTimer = setTimeout(() => {
        this.dom.toast.classList.add('toast-hidden');
      }, 2200);
    },

    // Abre editor com módulo carregado (modo editar)
    editModule(id) {
      const mod = this.state.stacks.find(s => s.id === id);
      if(!mod) return this.showToast("ERROR: MODULE NOT FOUND");
      this.toggleEditor(true, mod);
    },

    // Novo: aceita URL, tenta fetch; se fetch falhar faz fallback para abrir navFrame
    async handleRemoteUrl() {
      const url = prompt("INSIRA URL (http(s)://...):");
      if(!url) return;
      try {
        // tentativa de fetch do HTML (CORS pode bloquear)
        const res = await fetch(url, {mode:'cors'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const ct = res.headers.get('content-type') || '';
        if(ct.includes('text/html') || ct.includes('application/xhtml+xml')) {
          const text = await res.text();
          // salva como módulo automaticamente
          const mod = { id: Date.now(), title: url, content: text, date: new Date().toLocaleDateString() };
          this.state.stacks.unshift(mod);
          localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
          this.renderVault();
          this.showToast("REMOTE SAVED TO VAULT");
        } else {
          // não-html — apenas abre no navFrame
          this.dom.navFrame.src = url;
          this.showToast("OPENED IN NAV (non-HTML)");
        }
      } catch(err) {
        // Falha (CORS ou rede) — fallback: abrir no navFrame e avisar
        try {
          this.dom.navFrame.src = url;
          this.showToast("FALLBACK: OPENED IN NAV (fetch failed)");
        } catch(e) {
          this.showToast("ERROR: COULD NOT OPEN URL");
        }
      }
    }
  };

  window.onload = () => App.init();
</script>


<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script><script src="https://unpkg.com/lucide@latest"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script><script>
  const App = {
    config: {
      vaultKey: 'dual_vault_data',
      themeKey: 'dual_theme_mode',
      navKey: 'dual_nav_state',
      sysKey: 'dual_system_active'
    },
    state: {
      active: false,
      safeMode: true,
      stacks: [],
      editingId: null // novo: id do módulo que está sendo editado (null = criar novo)
    },

    init() {
      this.cacheDOM();
      this.loadData();
      this.bindEvents();
      if(window.lucide) lucide.createIcons();

      const theme = localStorage.getItem(this.config.themeKey);
      if(theme) document.documentElement.setAttribute('data-theme', theme);

      const wasActive = localStorage.getItem(this.config.sysKey) === 'true';
      if(wasActive) this.toggleSystem(true);
      else setTimeout(() => this.dom.orbBtn.classList.add('ready'), 500);
    },

    cacheDOM() {
      this.dom = {
        body: document.body,
        navFrame: document.getElementById('navFrame'),
        orbBtn: document.getElementById('orbBtn'),
        sysStatus: document.getElementById('sysStatus'),
        stackList: document.getElementById('stackList'),
        viewVault: document.getElementById('viewVault'),
        viewEditor: document.getElementById('viewEditor'),
        runtimeLayer: document.getElementById('runtimeLayer'),
        appFrame: document.getElementById('appFrame'),
        modTitle: document.getElementById('modTitle'),
        modContent: document.getElementById('modContent'),
        toast: document.getElementById('toast'),
        pulseBar: document.getElementById('pulseBar'),
        safeLabel: document.getElementById('safeLabel'),
        uploadInput: document.getElementById('uploadInput'),
        remoteBtn: document.getElementById('remoteBtn')
      };
    },

    bindEvents() {
      this.dom.orbBtn.addEventListener('click', () => this.toggleSystem());
      document.querySelectorAll('[data-url]').forEach(btn => {
        btn.addEventListener('click', () => {
          this.dom.navFrame.src = btn.dataset.url;
          this.showToast(`NAV: ${btn.title}`);
        });
      });

      document.getElementById('createBtn').addEventListener('click', () => this.toggleEditor(true));
      document.getElementById('cancelEditor').addEventListener('click', () => this.cancelEditing());
      document.getElementById('saveEditor').addEventListener('click', () => this.saveModule());

      document.getElementById('dropZone').addEventListener('click', () => this.dom.uploadInput.click());
      this.dom.uploadInput.addEventListener('change', (e) => this.handleUpload(e));
      document.getElementById('uploadBtn').addEventListener('click', () => this.dom.uploadInput.click());
      document.getElementById('backupBtn').addEventListener('click', () => this.exportVault());

      document.getElementById('safeBtn').addEventListener('click', () => this.toggleSafe());

      document.getElementById('themeToggle').addEventListener('click', () => {
         const current = document.documentElement.getAttribute('data-theme');
         const next = current === 'light' ? 'dark' : 'light';
         document.documentElement.setAttribute('data-theme', next);
         localStorage.setItem(this.config.themeKey, next);
         this.showToast(`THEME: ${next.toUpperCase()}`);
      });

      document.getElementById('closeRuntime').addEventListener('click', () => this.closeRuntime());
      document.getElementById('exportBtn').addEventListener('click', () => {
        if(this.dom.appFrame.srcdoc) {
          const blob = new Blob([this.dom.appFrame.srcdoc], {type:'text/html'});
          this.dom.navFrame.src = URL.createObjectURL(blob);
          this.showToast("EXPORTED TO NAV");
          this.closeRuntime();
        }
      });

      // Novo: botão globo aceita URLs
      this.dom.remoteBtn.addEventListener('click', () => this.handleRemoteUrl());
    },

    loadData() {
      try {
        const raw = localStorage.getItem(this.config.vaultKey);
        if(raw) this.state.stacks = JSON.parse(raw);
      } catch(e) { this.state.stacks = []; }
      this.renderVault();

      const last = localStorage.getItem(this.config.navKey);
      if(last && last !== 'about:blank') this.dom.navFrame.src = last;

      this.dom.navFrame.onload = () => {
        try { localStorage.setItem(this.config.navKey, this.dom.navFrame.contentWindow.location.href); } catch(e){}
      };
    },

    toggleSystem(force) {
      this.state.active = force !== undefined ? force : !this.state.active;
      localStorage.setItem(this.config.sysKey, this.state.active);
      if(this.state.active) {
        this.dom.body.classList.add('system-active');
        this.dom.sysStatus.innerText = "ONLINE";
        this.dom.sysStatus.style.color = "var(--neon-cyan)";
        this.dom.sysStatus.style.borderColor = "var(--neon-cyan)";
      } else {
        this.dom.body.classList.remove('system-active');
        this.dom.sysStatus.innerText = "STANDBY";
        this.dom.sysStatus.style.color = "var(--text-muted)";
        this.dom.sysStatus.style.borderColor = "var(--glass-border)";
      }
    },

    toggleEditor(show, moduleObj = null) {
      if(show) {
        this.dom.viewEditor.classList.remove('state-translated-x');
        if(moduleObj) {
          // abrir em modo edição
          this.state.editingId = moduleObj.id;
          this.dom.modTitle.value = moduleObj.title || '';
          this.dom.modContent.value = moduleObj.content || '';
        } else {
          this.state.editingId = null;
          this.dom.modTitle.value = '';
          this.dom.modContent.value = '';
        }
        this.dom.modTitle.focus();
      } else {
        this.dom.viewEditor.classList.add('state-translated-x');
      }
    },

    cancelEditing() {
      this.state.editingId = null;
      this.toggleEditor(false);
    },

    toggleSafe() {
      this.state.safeMode = !this.state.safeMode;
      this.dom.safeLabel.innerText = this.state.safeMode ? "SAFE" : "RAW";
      this.dom.safeLabel.style.color = this.state.safeMode ? "inherit" : "var(--alert-red)";
      this.showToast(this.state.safeMode ? "PROTOCOL: SAFE" : "PROTOCOL: RAW (UNSAFE)");
    },

    exportVault() {
      const data = JSON.stringify(this.state.stacks, null, 2);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dual-vault-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      this.showToast("VAULT EXPORTED");
    },

    saveModule() {
      const title = this.dom.modTitle.value.trim();
      const content = this.dom.modContent.value;
      if(!title) return this.showToast("ERROR: TITLE REQUIRED");

      if(this.state.editingId) {
        // Atualiza módulo existente
        const idx = this.state.stacks.findIndex(s => s.id === this.state.editingId);
        if(idx === -1) return this.showToast("ERROR: MODULE NOT FOUND");
        this.state.stacks[idx].title = title;
        this.state.stacks[idx].content = content;
        this.state.stacks[idx].date = new Date().toLocaleDateString();
        localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
        this.showToast("MODULE UPDATED");
      } else {
        // Cria novo módulo
        const mod = {
          id: Date.now(),
          title,
          content: content || '<h1>Empty Module</h1>',
          date: new Date().toLocaleDateString()
        };
        this.state.stacks.unshift(mod);
        localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
        this.showToast("MODULE CRYSTALLIZED");
      }

      this.state.editingId = null;
      this.renderVault();
      this.toggleEditor(false);
    },

    handleUpload(e) {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
          try {
              const json = JSON.parse(ev.target.result);
              if(Array.isArray(json) && json[0]?.id) {
                  if(confirm("RESTORE BACKUP? This will merge with current vault.")) {
                      this.state.stacks = [...json, ...this.state.stacks];
                      this.state.stacks = this.state.stacks.filter((v,i,a)=>a.findIndex(v2=>(v2.id===v.id))===i);
                      localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
                      this.renderVault();
                      this.showToast("BACKUP RESTORED");
                      return;
                  }
              }
          } catch(e) { /* Not a JSON array, treat as single file */ }

        this.state.stacks.unshift({
          id: Date.now(),
          title: file.name,
          content: ev.target.result,
          date: new Date().toLocaleDateString()
        });
        localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
        this.renderVault();
        this.showToast("FILE UPLOADED");
      };
      reader.readAsText(file);
      // reset input so same file can be re-uploaded if needed
      e.target.value = '';
    },

    deleteModule(id) {
      if(!confirm("DELETE MODULE?")) return;
      this.state.stacks = this.state.stacks.filter(s => s.id !== id);
      localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
      this.renderVault();
    },

    // Novo: download individual
    downloadModule(id) {
      const mod = this.state.stacks.find(s => s.id === id);
      if(!mod) return this.showToast("ERROR: NOT FOUND");
      const blob = new Blob([mod.content], {type: 'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // sanitize filename
      const safeName = (mod.title || 'module').replace(/[^\w\d\-_\.]/g,'_');
      a.download = `${safeName}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      this.showToast("DOWNLOAD STARTED");
    },

    renderVault() {
      this.dom.stackList.innerHTML = '';
      document.getElementById('vaultCount').innerText = `${this.state.stacks.length} ITEMS`;

      if(this.state.stacks.length === 0) {
        this.dom.stackList.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted); font-family:var(--font-code); font-size:12px;">VAULT EMPTY</div>`;
        return;
      }

      this.state.stacks.forEach(stack => {
        const el = document.createElement('div');
        el.className = 'stack-item';
        el.innerHTML = `
          <div class="stack-info">
            <div class="stack-icon"><i data-lucide="box" style="width:16px;"></i></div>
            <div class="stack-text">
              <h4>${this.escapeHtml(stack.title)}</h4>
              <span>${stack.date}</span>
            </div>
          </div>
          <div class="stack-actions">
            <button class="mini-btn btn-run" title="Run"><i data-lucide="play" style="width:12px;"></i></button>
            <button class="mini-btn btn-edit" title="Edit"><i data-lucide="edit-2" style="width:12px;"></i></button>
            <button class="mini-btn btn-dl" title="Download"><i data-lucide="download" style="width:12px;"></i></button>
            <button class="mini-btn btn-del" title="Delete"><i data-lucide="trash-2" style="width:12px;"></i></button>
          </div>
        `;

        // Bind actions
        el.querySelector('.btn-run').onclick = (e) => { e.stopPropagation(); this.runModule(stack.id); };
        el.querySelector('.btn-edit').onclick = (e) => { e.stopPropagation(); this.editModule(stack.id); };
        el.querySelector('.btn-dl').onclick = (e) => { e.stopPropagation(); this.downloadModule(stack.id); };
        el.querySelector('.btn-del').onclick = (e) => { e.stopPropagation(); this.deleteModule(stack.id); };
        el.onclick = () => this.runModule(stack.id);

        this.dom.stackList.appendChild(el);
      });

      if(window.lucide) lucide.createIcons();
    },

    escapeHtml(text) {
      if(!text) return '';
      return text.replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    },

    runModule(id) {
      const mod = this.state.stacks.find(s => s.id === id);
      if(!mod) return;

      let code = mod.content;
      if(this.state.safeMode) {
        try {
           if(!code.includes('<html') && !code.includes('<!doctype')) {
             code = `<style>body{color:#fff;background:transparent;font-family:sans-serif}</style>${code}`;
           }
        } catch(e){}
      }

      this.dom.appFrame.srcdoc = code;
      this.dom.runtimeLayer.classList.add('state-visible-y');
      this.dom.sysStatus.innerText = "RUNNING";
      this.dom.sysStatus.style.opacity = '0.7';
    },

    closeRuntime() {
      this.dom.runtimeLayer.classList.remove('state-visible-y');
      this.dom.sysStatus.style.opacity = '1';
      this.dom.sysStatus.innerText = "ONLINE";
      setTimeout(() => this.dom.appFrame.srcdoc = '', 400);
    },

    showToast(msg) {
      this.dom.toast.innerText = msg;
      this.dom.toast.classList.remove('toast-hidden');
      clearTimeout(this.toastTimer);
      this.toastTimer = setTimeout(() => {
        this.dom.toast.classList.add('toast-hidden');
      }, 2200);
    },

    // Abre editor com módulo carregado (modo editar)
    editModule(id) {
      const mod = this.state.stacks.find(s => s.id === id);
      if(!mod) return this.showToast("ERROR: MODULE NOT FOUND");
      this.toggleEditor(true, mod);
    },

    // Novo: aceita URL, tenta fetch; se fetch falhar faz fallback para abrir navFrame
    async handleRemoteUrl() {
      const url = prompt("INSIRA URL (http(s)://...):");
      if(!url) return;
      try {
        // tentativa de fetch do HTML (CORS pode bloquear)
        const res = await fetch(url, {mode:'cors'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const ct = res.headers.get('content-type') || '';
        if(ct.includes('text/html') || ct.includes('application/xhtml+xml')) {
          const text = await res.text();
          // salva como módulo automaticamente
          const mod = { id: Date.now(), title: url, content: text, date: new Date().toLocaleDateString() };
          this.state.stacks.unshift(mod);
          localStorage.setItem(this.config.vaultKey, JSON.stringify(this.state.stacks));
          this.renderVault();
          this.showToast("REMOTE SAVED TO VAULT");
        } else {
          // não-html — apenas abre no navFrame
          this.dom.navFrame.src = url;
          this.showToast("OPENED IN NAV (non-HTML)");
        }
      } catch(err) {
        // Falha (CORS ou rede) — fallback: abrir no navFrame e avisar
        try {
          this.dom.navFrame.src = url;
          this.showToast("FALLBACK: OPENED IN NAV (fetch failed)");
        } catch(e) {
          this.showToast("ERROR: COULD NOT OPEN URL");
        }
      }
    }
  };

  window.onload = () => App.init();
</script></body></html>